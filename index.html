<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LINE SHARE MESSAGE</title>
    <link rel="stylesheet" href="flex2html.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script type="text/javascript" src="flex2html.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: "Arial", sans-serif;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #pictureUrl {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-control {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: #2575fc;
            box-shadow: 0 0 0 0.2rem rgba(37, 117, 252, 0.25);
        }

        #flex1 {
            background-color: #839ebf;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-height: 300px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
        }

        #showtext {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 200px;
            line-height: 1.5;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn {
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            color: white !important;
        }

        .btn-danger {
            background-color: #ff4757;
            border-color: #ff4757;
        }

        .btn-primary {
            background-color: #2575fc;
            border-color: #2575fc;
        }

        .btn-warning {
            background-color: #ffa502;
            border-color: #ffa502;
        }

        .btn-dark {
            background-color: #2f3542;
            border-color: #2f3542;
        }

        .btn-info {
            background-color: #70a1ff;
            border-color: #70a1ff;
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }

        .btn-outline-light {
            color: #fff;
            border-color: #fff;
            background-color: transparent;
        }

        .btn-outline-light:hover {
            background-color: #fff;
            color: #2575fc !important;
        }

        .btn-secondary {
            background-color: #747d8c;
            border-color: #747d8c;
        }

        .btn-template {
            background-color: #00c4b4;
            border-color: #00c4b4;
        }

        .btn-sticker {
            background-color: #ff6b6b;
            border-color: #ff6b6b;
        }

        .btn-location {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #template-preview img {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        #template-preview .title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        #template-preview .text {
            margin-bottom: 10px;
        }

        #template-preview .action-btn {
            display: block;
            margin: 5px 0;
            padding: 10px;
            background-color: #00c4b4;
            color: white;
            text-align: center;
            border-radius: 5px;
            text-decoration: none;
        }

        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .json-fallback {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #locationInputs {
            display: none;
            margin-bottom: 15px;
        }

        .pulse-marker {
            background-color: rgba(255, 99, 71, 0.2);
            border-radius: 50%;
            animation: pulse 2s infinite;
            position: absolute;
            top: 0;
            left: 0;
            width: 60px;
            height: 60px;
        }
        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.3;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.7;
            }
        }

        #leaflet-popup-content .popup-header {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            text-align: center;
            margin-bottom: 5px;
        }
        #leaflet-popup-content .popup-button {
            background-color: #2575fc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        #leaflet-popup-content .popup-button:hover {
            background-color: #1e5fc7;
        }
        #leaflet-popup-content .popup-image-container {
            display: flex;
            justify-content: center;
            padding: 8px;
        }
        #leaflet-popup-content .popup-image {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            object-fit: cover;
        }

        #dataList {
            max-height: 300px;
            overflow-y: auto;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        #dataList table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }
        #dataList th, #dataList td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        #dataList th {
            background-color: #2575fc;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #dataList tr {
            transition: background-color 0.2s ease;
        }
        #dataList tr:hover {
            background-color: rgba(37, 117, 252, 0.1);
        }
        #dataList td.actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        #dataList .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        #dataList .btn-primary {
            background-color: #2575fc;
            border-color: #2575fc;
        }
        #dataList .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        #dataList .btn-danger {
            background-color: #ff4757;
            border-color: #ff4757;
        }
        #dataList .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        #dataList .no-data {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <center>
            <img id="pictureUrl" class="mb-2" alt="Profile Picture" />
            <p class="text-white mb-2" id="displayName"></p>
        </center>
        <h2 class="text-white text-center">❤️ ShareTargetPicker ❤️</h2>
        <div class="mb-3">
            <input class="form-control" type="text" id="textBox1"
                placeholder="หัวข้อสำหรับ Flex หรือ Template" />
        </div>
        <div class="mb-3">
            <textarea class="form-control" id="textBox2"
                placeholder="JSON สำหรับ Flex หรือ Template"></textarea>
        </div>
        <div id="locationInputs">
            <div class="mb-3">
                <input class="form-control" type="text" id="locationTitle"
                    placeholder="ชื่อสถานที่สำหรับ Location (เช่น ร้านกาแฟ ABC)" />
            </div>
            <div class="mb-3">
                <input class="form-control" type="text" id="locationAddress"
                    placeholder="ที่อยู่สำหรับ Location (เช่น 123 ถนนสีลม, กรุงเทพฯ)" />
            </div>
        </div>
        <div id="flex1" class="bg-white p-2 rounded mb-3" style="display: none"></div>
        <div id="showtext" class="bg-white p-2 rounded mb-3" style="display: none"></div>
        <div id="qr-reader" style="display: none; max-width: 300px; margin: 0 auto"></div>
        <div class="d-flex flex-wrap justify-content-center">
            <button class="btn btn-danger" onclick="showFlex(); toggleMessageDisplay('flex1')">
                Show Flex
            </button>
            <button class="btn btn-danger" onclick="sendFlex()">Send Flex</button>
            <button class="btn btn-primary" onclick="showImage(); toggleMessageDisplay('flex1')">
                Show Img
            </button>
            <button class="btn btn-primary" onclick="sendImage()">Send Img</button>
            <button class="btn btn-warning" onclick="showText(); toggleMessageDisplay('showtext')">
                Show Txt
            </button>
            <button class="btn btn-warning" onclick="sendText()">Send Text</button>
            <button class="btn btn-dark" onclick="showVideo()">Show Vid</button>
            <button class="btn btn-dark" onclick="sendVideo()">Send Vid</button>
            <button class="btn btn-info" onclick="getLocation()">Get Loc</button>
            <button class="btn btn-info" onclick="sendLocation()">Send Loc</button>
            <button class="btn btn-danger" onclick="scanQrCode()">Scan QR</button>
            <button class="btn btn-template" onclick="showTemplate(); toggleMessageDisplay('flex1')">
                Show Template
            </button>
            <button class="btn btn-template" onclick="sendTemplate()">
                Send Template
            </button>
            <button class="btn btn-sticker" onclick="showSticker(); toggleMessageDisplay('flex1')">
                Show Sticker
            </button>
            <button class="btn btn-sticker" onclick="sendSticker()">
                Send Sticker
            </button>
            <button class="btn btn-secondary" onclick="formatJson()">
                Format JSON
            </button>
            <button class="btn btn-secondary" onclick="clearText()">
                ล้างข้อความทั้งหมด
            </button>
            <button class="btn btn-primary" id="shareLocationBtn" onclick="shareLocation()">
                Share Location
            </button>
            <button class="btn btn-primary" id="refreshBtn" onclick="shareFlex()">
                Share Flex
            </button>
            <button class="btn btn-success" onclick="saveToSupabase()">
                บันทึก Flex Message
            </button>
            <button class="btn btn-success" onclick="saveTemplateToSupabase()">
                บันทึก Template Message
            </button>
        </div>
        <div id="dataList" class="mt-3 bg-white p-2 rounded"></div>
    </div>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const liffId = "2005780370-QmwJlX9q";
        const SUPABASE_FUNCTIONS_URL = 'https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/submit-liff-shartargetpicker';
        let profile;
        let jsonIndentLevel = 4;
        let map = null;
        let markers = [];
        window.listData = window.listData || [];
        window.currentItemId = null;

        liff
            .init({ liffId })
            .then(() => {
                if (liff.isLoggedIn()) {
                    liff.getProfile().then((p) => {
                        profile = p;
                        document.getElementById("pictureUrl").src = profile.pictureUrl;
                        document.getElementById("displayName").textContent = `สวัสดี: ${profile.displayName}`;
                        fetchDataList();
                    }).catch((err) => {
                        Swal.fire({
                            icon: "error",
                            title: "ไม่สามารถดึงข้อมูลโปรไฟล์ได้",
                            text: err.message,
                        });
                    });
                } else {
                    liff.login();
                }
            })
            .catch((err) => {
                Swal.fire({
                    icon: "error",
                    title: "ไม่สามารถเริ่มต้น LIFF ได้",
                    text: err.message,
                });
            });

        function toggleMessageDisplay(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = element.style.display === "none" ? "block" : "none";
        }

        function showLoading() {
            Swal.fire({
                title: "กำลังโหลด...",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                },
            });
        }

        function hideLoading() {
            Swal.close();
        }

        function navigateTo(lat, lng) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        function addPulseMarker(position, imageUrl, displayName, timestamp) {
            const iconHtml = `
                <div style="position: relative; width: 80px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <div style="position: relative; width: 60px; height: 60px;">
                        <div class="pulse-marker" style="width: 60px; height: 60px; position: absolute;"></div>
                        <img src="${imageUrl}" style="width: 50px; height: 50px; border-radius: 50%; position: absolute; top: 5px; left: 5px; border: 3px solid white; object-fit: cover;">
                    </div>
                    <div style="width: 80px; text-align: center;">
                        <p style="margin: 0; font-size: 0.85rem; color: #333; font-weight: bold; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(displayName)}</p>
                    </div>
                </div>
            `;
            const customIcon = L.divIcon({
                html: iconHtml,
                className: '',
                iconSize: [80, 90],
                iconAnchor: [40, 45],
                popupAnchor: [0, -45]
            });
            const marker = L.marker(position, { icon: customIcon }).addTo(map);
            marker.bindPopup(`
                <div id="leaflet-popup-content">
                    <div class="popup-header">${escapeHtml(displayName)}</div>
                    <div class="popup-image-container">
                        <img src="${imageUrl}" class="popup-image">
                    </div>
                    <div class="p-2 text-center">
                        <p>อัปเดตล่าสุด: ${new Date(timestamp).toLocaleString('th-TH', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})} น.</p>
                        <button class="popup-button" onclick="navigateTo(${position[0]},${position[1]})">ไปยังตำแหน่งนี้</button>
                    </div>
                </div>
            `);
            markers.push(marker);
        }

        function getLocation() {
            if (!navigator.geolocation) {
                Swal.fire({
                    icon: "error",
                    title: "Geolocation ไม่รองรับ",
                    text: "เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง",
                });
                return;
            }
            showLoading();
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    document.getElementById("textBox1").value = latitude;
                    document.getElementById("textBox2").value = longitude;
                    document.getElementById("locationInputs").style.display = "block";

                    const flexContainer = document.getElementById("flex1");
                    flexContainer.innerHTML = '<div id="map"></div>';
                    flexContainer.style.display = "block";

                    map = L.map('map').setView([latitude, longitude], 17);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    addPulseMarker([latitude, longitude], profile.pictureUrl, profile.displayName, new Date().toISOString());

                    Swal.fire({
                        icon: "success",
                        title: "ดึงตำแหน่งสำเร็จ",
                        text: `Latitude: ${latitude}, Longitude: ${longitude}`,
                        timer: 2000,
                        showConfirmButton: false,
                    });
                },
                (error) => {
                    let errorMessage;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "ผู้ใช้ปฏิเสธการร้องขอตำแหน่ง";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "ข้อมูลตำแหน่งไม่พร้อมใช้งาน";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "การร้องขอตำแหน่งหมดเวลา";
                            break;
                        default:
                            errorMessage = "เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ";
                            break;
                    }
                    Swal.fire({
                        icon: "error",
                        title: "ไม่สามารถดึงตำแหน่งได้",
                        text: errorMessage,
                    });
                }
            );
            hideLoading();
        }

        function showLocation() {
            const flexContainer = document.getElementById("flex1");
            flexContainer.innerHTML = '<div id="map"></div>';
            const textBox1 = document.getElementById("textBox1").value.trim();
            const textBox2 = document.getElementById("textBox2").value.trim();
            const titleInput = document.getElementById("locationTitle").value.trim();
            const addressInput = document.getElementById("locationAddress").value.trim();

            let latitude = 13.7563, longitude = 100.5018, title = titleInput || "Location", address = addressInput || "View on map";

            try {
                if (textBox2 && !isNaN(parseFloat(textBox1)) && !isNaN(parseFloat(textBox2))) {
                    latitude = parseFloat(textBox1);
                    longitude = parseFloat(textBox2);
                } else if (textBox2) {
                    try {
                        const parsed = JSON.parse(textBox2);
                        if (parsed.type === "location" && parsed.latitude && parsed.longitude) {
                            latitude = parseFloat(parsed.latitude);
                            longitude = parseFloat(parsed.longitude);
                            title = parsed.title || title;
                            address = parsed.address || address;
                        } else {
                            throw new Error("Invalid location JSON format");
                        }
                    } catch {
                        throw new Error("Invalid JSON or latitude/longitude values");
                    }
                }

                if (isNaN(latitude) || isNaN(longitude)) {
                    throw new Error("Latitude and longitude must be valid numbers");
                }

                map = L.map('map').setView([latitude, longitude], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                addPulseMarker([latitude, longitude], profile.pictureUrl, profile.displayName, new Date().toISOString());

                flexContainer.style.display = "block";
            } catch (error) {
                flexContainer.innerHTML = `<p class="text-danger">Invalid location data: ${error.message}</p>`;
                Swal.fire({
                    icon: "error",
                    title: "ข้อมูลตำแหน่งไม่ถูกต้อง",
                    text: error.message,
                });
            }
        }

        async function shareLocation() {
            if (!navigator.geolocation) {
                Swal.fire({
                    icon: "error",
                    title: "Geolocation ไม่รองรับ",
                    text: "เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง",
                });
                return;
            }
            if (!profile || !profile.userId) {
                Swal.fire({
                    icon: "error",
                    title: "โปรไฟล์ยังไม่โหลด",
                    text: "กรุณารอสักครู่แล้วลองใหม่",
                });
                return;
            }
            showLoading();
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const title = document.getElementById("locationTitle").value.trim() || profile.displayName || "My Location";
                    const address = document.getElementById("locationAddress").value.trim() || "View on map";

                    const locationMessage = {
                        type: "location",
                        title: title,
                        address: address,
                        latitude: latitude,
                        longitude: longitude
                    };

                    sendMessage(locationMessage);
                    hideLoading();
                },
                (error) => {
                    hideLoading();
                    let errorMessage;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "ผู้ใช้ปฏิเสธการร้องขอตำแหน่ง";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "ข้อมูลตำแหน่งไม่พร้อมใช้งาน";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "การร้องขอตำแหน่งหมดเวลา";
                            break;
                        default:
                            errorMessage = "เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ";
                            break;
                    }
                    Swal.fire({
                        icon: "error",
                        title: "ไม่สามารถดึงตำแหน่งได้",
                        text: errorMessage,
                    });
                }
            );
        }

        async function shareFlex() {
            if (!navigator.geolocation) {
                Swal.fire({
                    icon: "error",
                    title: "Geolocation ไม่รองรับ",
                    text: "เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง",
                });
                return;
            }
            if (!profile || !profile.userId) {
                Swal.fire({
                    icon: "error",
                    title: "โปรไฟล์ยังไม่โหลด",
                    text: "กรุณารอสักครู่แล้วลองใหม่",
                });
                return;
            }
            showLoading();
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const flex = [{
                        type: "location",
                        title: profile.displayName,
                        address: "คลิกเพื่อเปิดแผนที่",
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude
                    }, {
                        type: "flex",
                        altText: "My Location",
                        contents: {
                            type: "bubble",
                            body: {
                                type: "box",
                                layout: "vertical",
                                contents: [
                                    {
                                        type: "box",
                                        layout: "horizontal",
                                        contents: [
                                            {
                                                type: "image",
                                                url: "https://media.giphy.com/media/SWWLF8WluVJ5vJjMln/giphy.gif",
                                                size: "xs",
                                                flex: 0
                                            },
                                            {
                                                type: "text",
                                                text: "สถานที่ของฉัน",
                                                gravity: "center",
                                                weight: "bold"
                                            }
                                        ]
                                    },
                                    {
                                        type: "separator",
                                        margin: "md"
                                    },
                                    {
                                        type: "box",
                                        layout: "horizontal",
                                        contents: [
                                            {
                                                type: "box",
                                                layout: "vertical",
                                                contents: [
                                                    {
                                                        type: "image",
                                                        url: profile.pictureUrl
                                                    }
                                                ],
                                                width: "60px",
                                                height: "60px",
                                                cornerRadius: "150px",
                                                borderWidth: "2px",
                                                borderColor: "#ff9966"
                                            },
                                            {
                                                type: "text",
                                                text: profile.displayName,
                                                gravity: "center",
                                                margin: "md"
                                            }
                                        ],
                                        margin: "md"
                                    },
                                    {
                                        type: "button",
                                        action: {
                                            type: "uri",
                                            label: "คลิกนำทาง",
                                            uri: `https://www.google.com/maps/dir/?api=1&destination=${pos.coords.latitude},${pos.coords.longitude}`
                                        },
                                        style: "primary",
                                        height: "sm",
                                        margin: "md",
                                        color: "#ff9966"
                                    },
                                    {
                                        type: "button",
                                        action: {
                                            type: "uri",
                                            label: "เยี่ยมบ้านเพื่อน",
                                            uri: `https://liff.line.me/${liffId}`
                                        },
                                        style: "primary",
                                        height: "sm",
                                        margin: "md",
                                        color: "#578ee4"
                                    }
                                ]
                            }
                        }
                    }];
                    sendMessage(flex);
                    hideLoading();
                },
                (error) => {
                    hideLoading();
                    Swal.fire({
                        icon: "error",
                        title: "ไม่สามารถดึงตำแหน่งได้",
                        text: "กรุณาอนุญาตการเข้าถึงตำแหน่งหรือลองอีกครั้ง",
                    });
                }
            );
        }

        function showImage() {
            const src = document.getElementById("textBox2").value;
            document.getElementById("flex1").innerHTML = `<img src="${src}" alt="Shared Image">`;
        }

        function showFlex() {
            const flexContainer = document.getElementById("flex1");
            flexContainer.innerHTML = "";
            try {
                const flexJson = document.getElementById("textBox2").value;
                const flexObject = JSON.parse(flexJson);
                const flexMessage = {
                    type: "flex",
                    altText: "Flex Message",
                    contents: flexObject,
                };
                if (typeof flex2html === "function") {
                    flex2html("flex1", flexMessage);
                } else {
                    flexContainer.innerHTML = '<p class="text-danger">flex2html library is not loaded properly.</p>';
                }
            } catch (error) {
                flexContainer.innerHTML = '<p class="text-danger">Invalid Flex JSON. Please check your input.</p>';
            }
        }

        function showText() {
            const showTextElement = document.getElementById("showtext");
            showTextElement.textContent = document.getElementById("textBox2").value;
        }

        function showSticker() {
            const flexContainer = document.getElementById("flex1");
            flexContainer.innerHTML = "";
            const packageId = document.getElementById("textBox1").value || "11537";
            const stickerId = document.getElementById("textBox2").value || "52002734";
            const stickerUrl = `https://stickershop.line-scdn.net/stickershop/v1/sticker/${stickerId}/android/sticker.png`;
            flexContainer.innerHTML = `<img src="${stickerUrl}" alt="Sticker (packageId: ${packageId}, stickerId: ${stickerId})" style="max-width: 200px;" onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=Sticker+Not+Found';">`;
        }

        function showTemplate() {
            const flexContainer = document.getElementById("flex1");
            flexContainer.innerHTML = "";
            const templateJson = document.getElementById("textBox2").value.trim();
            if (!templateJson) {
                flexContainer.innerHTML = '<p class="text-danger">Please provide a valid JSON in the second input.</p>';
                return;
            }
            try {
                const templateObject = JSON.parse(templateJson);
                flexContainer.innerHTML = `<pre class="json-fallback">${escapeHtml(JSON.stringify(templateObject, null, 2))}</pre>`;
            } catch (error) {
                flexContainer.innerHTML = '<p class="text-danger">Invalid JSON. Please check your input.</p>';
            }
        }

        function formatJson() {
            const textBox2 = document.getElementById("textBox2");
            const jsonString = textBox2.value.trim();
            if (!jsonString) {
                Swal.fire({
                    icon: "error",
                    title: "No JSON to format",
                    text: "Please provide a JSON string in the second input.",
                });
                return;
            }
            try {
                const jsonObj = JSON.parse(jsonString);
                jsonIndentLevel = jsonIndentLevel === 2 ? 4 : jsonIndentLevel === 4 ? 0 : 2;
                const indentLabel = jsonIndentLevel === 0 ? "minified" : `${jsonIndentLevel} spaces`;
                textBox2.value = JSON.stringify(jsonObj, null, jsonIndentLevel);
                Swal.fire({
                    icon: "success",
                    title: "JSON Formatted",
                    text: `Formatted with ${indentLabel} indentation.`,
                    timer: 1500,
                    showConfirmButton: false,
                });
            } catch (error) {
                Swal.fire({
                    icon: "error",
                    title: "Invalid JSON",
                    text: `Please check your JSON input: ${error.message}`,
                });
            }
        }

        function isValidStickerMessage(packageId, stickerId) {
            return packageId && stickerId && /^\d+$/.test(packageId) && /^\d+$/.test(stickerId);
        }

        function isValidFlexMessage(obj) {
            return (
                obj &&
                (obj.type === "bubble" ||
                    obj.type === "carousel" ||
                    (obj.type === "flex" && obj.contents))
            );
        }

        function isValidTemplateMessage(obj) {
            return obj && (obj.type === "template" || obj.type === "location");
        }

        async function saveToSupabase(retryCount = 0, maxRetries = 3) {
            if (!profile || !profile.userId) {
                Swal.fire({
                    icon: "error",
                    title: "โปรไฟล์ยังไม่โหลด",
                    text: "กรุณารอสักครู่แล้วลองใหม่",
                });
                return;
            }
            const flexJson = document.getElementById("textBox2").value;
            const title = document.getElementById("textBox1").value;
            if (!title.trim()) {
                Swal.fire({
                    icon: "error",
                    title: "กรุณากรอกหัวข้อ",
                    text: "หัวข้อไม่สามารถเป็นค่าว่างได้",
                });
                return;
            }
            let flexObj;
            try {
                flexObj = JSON.parse(flexJson);
                if (!isValidFlexMessage(flexObj)) {
                    throw new Error("ไม่ใช่ Flex Message ที่ถูกต้อง");
                }
            } catch (error) {
                Swal.fire({
                    icon: "error",
                    title: "JSON ไม่ถูกต้อง",
                    text: `กรุณาตรวจสอบ JSON Flex Message ของคุณ: ${error.message}`,
                });
                return;
            }
            const data = {
                id: window.currentItemId || undefined,
                title: title,
                text1: flexJson,
                userId: profile.userId,
                displayName: profile.displayName,
                type: "flex"
            };
            showLoading();
            try {
                const method = window.currentItemId ? "PUT" : "POST";
                const response = await fetch(SUPABASE_FUNCTIONS_URL, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    const text = await response.text();
                    let errorMessage = `Network response was not ok: ${response.status}`;
                    if (response.status === 400) {
                        errorMessage = `Invalid request: ${text}`;
                    } else if (response.status === 500) {
                        errorMessage = `Server error: ${text}`;
                    }
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.success) {
                    Swal.fire({
                        icon: "success",
                        title: window.currentItemId ? "อัปเดตข้อมูลเรียบร้อย!" : "บันทึกข้อมูลเรียบร้อย!",
                        timer: 1500,
                        showConfirmButton: false,
                    });
                    window.currentItemId = null;
                    clearInputs();
                    fetchDataList();
                } else {
                    throw new Error(result.error || "Unknown error occurred");
                }
            } catch (error) {
                if (retryCount < maxRetries) {
                    setTimeout(() => saveToSupabase(retryCount + 1, maxRetries), 1000);
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
                        text: error.message,
                    });
                }
            } finally {
                hideLoading();
            }
        }

        async function saveTemplateToSupabase(retryCount = 0, maxRetries = 3) {
            if (!profile || !profile.userId) {
                Swal.fire({
                    icon: "error",
                    title: "โปรไฟล์ยังไม่โหลด",
                    text: "กรุณารอสักครู่แล้วลองใหม่",
                });
                return;
            }
            const templateJson = document.getElementById("textBox2").value;
            const title = document.getElementById("textBox1").value;
            if (!title.trim()) {
                Swal.fire({
                    icon: "error",
                    title: "กรุณากรอกหัวข้อ",
                    text: "หัวข้อไม่สามารถเป็นค่าว่างได้",
                });
                return;
            }
            let templateObj;
            try {
                templateObj = JSON.parse(templateJson);
                if (!isValidTemplateMessage(templateObj)) {
                    throw new Error("ไม่ใช่ Template Message ที่ถูกต้อง: ต้องมีฟิลด์ 'type'");
                }
            } catch (error) {
                Swal.fire({
                    icon: "error",
                    title: "JSON ไม่ถูกต้อง",
                    text: `กรุณาตรวจสอบ JSON Template Message ของคุณ: ${error.message}`,
                });
                return;
            }
            const data = {
                id: window.currentItemId || undefined,
                title: title,
                text1: templateJson,
                userId: profile.userId,
                displayName: profile.displayName,
                type: "template"
            };
            showLoading();
            try {
                const method = window.currentItemId ? "PUT" : "POST";
                const response = await fetch(SUPABASE_FUNCTIONS_URL, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    const text = await response.text();
                    let errorMessage = `Network response was not ok: ${response.status}`;
                    if (response.status === 400) {
                        errorMessage = `Invalid request: ${text}`;
                    } else if (response.status === 500) {
                        errorMessage = `Server error: ${text}`;
                    }
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.success) {
                    Swal.fire({
                        icon: "success",
                        title: window.currentItemId ? "อัปเดตข้อมูลเรียบร้อย!" : "บันทึกข้อมูลเรียบร้อย!",
                        timer: 1500,
                        showConfirmButton: false,
                    });
                    window.currentItemId = null;
                    clearInputs();
                    fetchDataList();
                } else {
                    throw new Error(result.error || "Unknown error occurred");
                }
            } catch (error) {
                if (retryCount < maxRetries) {
                    setTimeout(() => saveTemplateToSupabase(retryCount + 1, maxRetries), 1000);
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
                        text: error.message,
                    });
                }
            } finally {
                hideLoading();
            }
        }

        async function fetchDataList(retryCount = 0, maxRetries = 3) {
            if (!profile || !profile.userId) {
                return;
            }
            showLoading();
            try {
                console.log("Fetching data for userId:", profile.userId);
                const response = await fetch(`${SUPABASE_FUNCTIONS_URL}?userId=${encodeURIComponent(profile.userId)}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {
                    const text = await response.text();
                    let errorMessage = `Network response was not ok: ${response.status}`;
                    if (response.status === 400) {
                        errorMessage = `Invalid request: ${text}`;
                    } else if (response.status === 500) {
                        errorMessage = `Server error: ${text}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                console.log("Fetched data:", data);
                if (!Array.isArray(data)) {
                    throw new Error("Data is not an array");
                }
                window.listData = data;
                renderDataList();
            } catch (error) {
                console.error("Error fetching data:", error);
                if (retryCount < maxRetries) {
                    console.log(`Retrying fetchDataList (${retryCount + 1}/${maxRetries})...`);
                    setTimeout(() => fetchDataList(retryCount + 1, maxRetries), 1000);
                } else {
                    const dataListElement = document.getElementById("dataList");
                    if (dataListElement) {
                        dataListElement.innerHTML = `<p class="no-data">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</p>`;
                    }
                    Swal.fire({
                        icon: "error",
                        title: "ไม่สามารถโหลดข้อมูลได้",
                        text: "กรุณาลองรีเฟรชหน้าเว็บ",
                    });
                }
            } finally {
                hideLoading();
            }
        }

        function renderDataList() {
            const dataListContainer = document.getElementById("dataList");
            dataListContainer.innerHTML = "";
            if (!window.listData || window.listData.length === 0) {
                dataListContainer.innerHTML = '<p class="no-data">ไม่มีข้อมูลที่บันทึกไว้</p>';
                return;
            }
            const table = document.createElement("table");
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>หัวข้อ</th>
                        <th>ประเภท</th>
                        <th>การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector("tbody");
            window.listData.forEach((item, index) => {
                if (!item) return;
                const row = document.createElement("tr");
                const title = item.title || 'ไม่มีหัวข้อ';
                const type = item.type || 'unknown';
                row.innerHTML = `
                    <td>${escapeHtml(title)}</td>
                    <td>${escapeHtml(type.charAt(0).toUpperCase() + type.slice(1))}</td>
                    <td class="actions">
                        <button class="btn btn-primary" onclick="showMessage('${item.id}')">แสดง</button>
                        <button class="btn btn-success" onclick="shareListItem('${item.id}')">แชร์</button>
                        <button class="btn btn-danger" onclick="deleteListItem('${item.id}')">ลบ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            dataListContainer.appendChild(table);
        }

        async function showMessage(id, retryCount = 0, maxRetries = 3) {
            console.log("Attempting to show message for id:", id, "Retry count:", retryCount);
            console.log("Current listData:", window.listData);
            if (!window.listData || !Array.isArray(window.listData)) {
                console.warn("listData is not initialized or not an array, attempting to fetch...");
                if (retryCount < maxRetries) {
                    try {
                        await fetchDataList();
                        return showMessage(id, retryCount + 1, maxRetries);
                    } catch (error) {
                        console.error("Failed to fetch data list:", error);
                        Swal.fire({
                            icon: "error",
                            title: "ไม่สามารถโหลดข้อมูลได้",
                            text: "เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาลองรีเฟรชหน้าเว็บ",
                            confirmButtonText: "รีเฟรช",
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.reload();
                            }
                        });
                        return;
                    }
                }
                Swal.fire({
                    icon: "error",
                    title: "ไม่สามารถโหลดข้อมูลได้",
                    text: "ไม่สามารถโหลดรายการข้อมูลได้หลังจากลองใหม่ กรุณารีเฟรชหน้าเว็บ",
                    confirmButtonText: "รีเฟรช",
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload();
                    }
                });
                return;
            }

            const item = window.listData.find(item => String(item.id) === String(id));
            if (!item) {
                console.error("showMessage: Item not found for id:", id, "in listData:", window.listData);
                if (retryCount < maxRetries) {
                    console.log(`Retrying showMessage (${retryCount + 1}/${maxRetries})...`);
                    try {
                        await fetchDataList();
                        return showMessage(id, retryCount + 1, maxRetries);
                    } catch (error) {
                        console.error("Failed to fetch data list on retry:", error);
                    }
                }
                Swal.fire({
                    icon: "error",
                    title: "ไม่พบข้อมูล",
                    text: "ไม่พบรายการที่ร้องขอ กรุณาลองรีเฟรชหน้าเว็บ",
                    confirmButtonText: "รีเฟรช",
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload();
                    }
                });
                return;
            }

            if (!item.text1 || !item.type) {
                console.error("showMessage: Missing text1 or type for item:", item);
                Swal.fire({
                    icon: "error",
                    title: "ข้อมูลไม่สมบูรณ์",
                    text: "ข้อมูลข้อความขาดฟิลด์ text1 หรือ type",
                });
                return;
            }

            console.log("Found item:", item);
            document.getElementById("textBox1").value = item.title || "";
            document.getElementById("textBox2").value = item.text1;
            window.currentItemId = id;

            const flexContainer = document.getElementById("flex1");
            if (!flexContainer) {
                console.error("Flex container not found");
                Swal.fire({
                    icon: "error",
                    title: "ข้อผิดพลาด",
                    text: "ไม่พบคอนเทนเนอร์สำหรับแสดงข้อความ",
                });
                return;
            }

            flexContainer.innerHTML = "";
            try {
                const obj = JSON.parse(item.text1);
                console.log("Parsed message object:", obj);

                if (item.type === "flex") {
                    if (!isValidFlexMessage(obj)) {
                        throw new Error("โครงสร้าง Flex Message ไม่ถูกต้อง");
                    }
                    let flexMessage;
                    if (obj.type === "carousel" || obj.type === "bubble") {
                        flexMessage = {
                            type: "flex",
                            altText: item.title || "Flex Message",
                            contents: obj,
                        };
                    } else {
                        flexMessage = obj;
                    }
                    if (typeof flex2html === "function") {
                        flex2html("flex1", flexMessage);
                        flexContainer.style.display = "block";
                        flexContainer.classList.remove("bg-white", "p-2", "rounded");
                        flexContainer.scrollIntoView({ behavior: "smooth" });
                    } else {
                        console.error("flex2html function is not available");
                        flexContainer.innerHTML = '<p class="text-danger">ไม่สามารถโหลดไลบรารี flex2html ได้</p>';
                    }
                } else if (item.type === "template") {
                    if (!isValidTemplateMessage(obj)) {
                        throw new Error("โครงสร้าง Template Message ไม่ถูกต้อง: ต้องมีฟิลด์ 'type'");
                    }
                    flexContainer.innerHTML = `
                        <pre class="json-fallback">${escapeHtml(JSON.stringify(obj, null, 2))}</pre>
                    `;
                    flexContainer.style.display = "block";
                    flexContainer.scrollIntoView({ behavior: "smooth" });
                } else {
                    throw new Error("ประเภทข้อความไม่รู้จัก");
                }
            } catch (e) {
                console.error("Error in showMessage:", e, "item:", item);
                flexContainer.innerHTML = `<p class="text-danger">ข้อผิดพลาดในการแสดงข้อความ: ${e.message}</p>`;
                Swal.fire({
                    icon: "error",
                    title: "ไม่สามารถแสดงข้อความได้",
                    text: `รูปแบบข้อมูลไม่ถูกต้อง: ${e.message}`,
                });
            }
        }

        async function shareListItem(id, retryCount = 0, maxRetries = 3) {
            console.log("Attempting to share item with id:", id, "Retry count:", retryCount);
            console.log("Current listData:", window.listData);
            if (!window.listData || !Array.isArray(window.listData)) {
                console.warn("listData is not initialized or not an array, attempting to fetch...");
                if (retryCount < maxRetries) {
                    try {
                        await fetchDataList();
                        return shareListItem(id, retryCount + 1, maxRetries);
                    } catch (error) {
                        console.error("Failed to fetch data list:", error);
                        Swal.fire({
                            icon: "error",
                            title: "ไม่สามารถโหลดข้อมูลได้",
                            text: "เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาลองรีเฟรชหน้าเว็บ",
                            confirmButtonText: "รีเฟรช",
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.reload();
                            }
                        });
                        return;
                    }
                }
                Swal.fire({
                    icon: "error",
                    title: "ไม่สามารถโหลดข้อมูลได้",
                    text: "ไม่สามารถโหลดรายการข้อมูลได้หลังจากลองใหม่ กรุณารีเฟรชหน้าเว็บ",
                    confirmButtonText: "รีเฟรช",
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload();
                    }
                });
                return;
            }

            const item = window.listData.find(item => String(item.id) === String(id));
            if (!item) {
                console.error("shareListItem: Item not found for id:", id, "in listData:", window.listData);
                if (retryCount < maxRetries) {
                    console.log(`Retrying shareListItem (${retryCount + 1}/${maxRetries})...`);
                    try {
                        await fetchDataList();
                        return shareListItem(id, retryCount + 1, maxRetries);
                    } catch (error) {
                        console.error("Failed to fetch data list on retry:", error);
                    }
                }
                Swal.fire({
                    icon: "error",
                    title: "ไม่พบข้อมูล",
                    text: "ไม่พบรายการที่ร้องขอ กรุณาลองรีเฟรชหน้าเว็บ",
                    confirmButtonText: "รีเฟรช",
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload();
                    }
                });
                return;
            }

            if (!item.text1 || !item.type) {
                console.error("shareListItem: Missing text1 or type for item:", item);
                Swal.fire({
                    icon: "error",
                    title: "ข้อมูลไม่สมบูรณ์",
                    text: "ข้อมูลข้อความขาดฟิลด์ text1 หรือ type",
                });
                return;
            }

            try {
                const obj = JSON.parse(item.text1);
                console.log("Parsed message object for sharing:", obj);
                let messageObj;
                if (item.type === "flex") {
                    if (!isValidFlexMessage(obj)) {
                        throw new Error("โครงสร้าง Flex Message ไม่ถูกต้อง");
                    }
                    if (obj.type === "carousel" || obj.type === "bubble") {
                        messageObj = {
                            type: "flex",
                            altText: item.title || "Flex Message",
                            contents: obj,
                        };
                    } else {
                        messageObj = obj;
                    }
                } else if (item.type === "template") {
                    if (!isValidTemplateMessage(obj)) {
                        throw new Error("โครงสร้าง Template Message ไม่ถูกต้อง: ต้องมีฟิลด์ 'type'");
                    }
                    messageObj = {
                        template: obj
                    };
                } else {
                    throw new Error("ประเภทข้อความไม่รู้จัก");
                }
                sendMessage(messageObj);
            } catch (e) {
                console.error("Error in shareListItem:", e, "item:", item);
                Swal.fire({
                    icon: "error",
                    title: "ไม่สามารถแชร์ข้อความได้",
                    text: `รูปแบบข้อมูลไม่ถูกต้อง: ${e.message}`,
                });
            }
        }

        async function deleteItemFromServer(id, retryCount = 0, maxRetries = 3) {
            if (!profile || !profile.userId) {
                throw new Error("โปรไฟล์ยังไม่โหลด");
            }
            console.log("Deleting item with id:", id);
            try {
                const response = await fetch(`${SUPABASE_FUNCTIONS_URL}?id=${encodeURIComponent(id)}&userId=${encodeURIComponent(profile.userId)}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {
                    const text = await response.text();
                    let errorMessage = `Network response was not ok: ${response.status}`;
                    if (response.status === 400) {
                        errorMessage = `Invalid request: ${text}`;
                    } else if (response.status === 403) {
                        errorMessage = `Unauthorized: ${text}`;
                    } else if (response.status === 404) {
                        errorMessage = `Item not found: ${text}`;
                    } else if (response.status === 500) {
                        errorMessage = `Server error: ${text}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                console.log("Delete response:", data);
                if (!data.success) {
                    throw new Error(data.error || "Unknown error occurred");
                }
                return data;
            } catch (error) {
                if (retryCount < maxRetries) {
                    console.log(`Retrying deleteItemFromServer (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return deleteItemFromServer(id, retryCount + 1, maxRetries);
                }
                throw error;
            }
        }

        function deleteListItem(id) {
            Swal.fire({
                title: "คุณแน่ใจหรือไม่?",
                text: "คุณไม่สามารถย้อนกลับการกระทำนี้ได้!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "ใช่, ลบเลย!",
                cancelButtonText: "ยกเลิก",
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    deleteItemFromServer(id)
                        .then(() => {
                            Swal.fire({
                                icon: "success",
                                title: "ลบสำเร็จ!",
                                text: "รายการได้ถูกลบเรียบร้อยแล้ว",
                                timer: 1500,
                                showConfirmButton: false,
                            });
                            fetchDataList();
                            window.currentItemId = null;
                        })
                        .catch((error) => {
                            console.error("Error deleting item:", error);
                            Swal.fire({
                                icon: "error",
                                title: "เกิดข้อผิดพลาด!",
                                text: `ไม่สามารถลบรายการได้: ${error.message}`,
                            });
                        })
                        .finally(() => {
                            hideLoading();
                        });
                }
            });
        }

        function sendMessage(messageObj) {
            showLoading();
            const messages = Array.isArray(messageObj) ? messageObj : [messageObj];
            liff
                .shareTargetPicker(messages)
                .then(() => {
                    Swal.fire({
                        icon: "success",
                        title: "แชร์สำเร็จ!",
                        text: "ข้อความถูกแชร์เรียบร้อยแล้ว",
                        timer: 1500,
                        showConfirmButton: false,
                    });
                })
                .catch((error) => {
                    console.error("Error sending message:", error);
                    Swal.fire({
                        icon: "error",
                        title: "ไม่สามารถแชร์ข้อความได้",
                        text: error.message,
                    });
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function sendTemplate() {
            const templateJson = document.getElementById("textBox2").value.trim();
            if (!templateJson) {
                Swal.fire({
                    icon: "error",
                    title: "Missing Message JSON",
                    text: "Please provide a valid JSON in the second input.",
                });
                return;
            }
            try {
                const messageObj = JSON.parse(templateJson);
                if (!isValidTemplateMessage(messageObj)) {
                    Swal.fire({
                        icon: "error",
                        title: "Invalid Message Type",
                        text: "JSON must have type 'template' or 'location'.",
                    });
                    return;
                }
                sendMessage(messageObj);
            } catch (error) {
                Swal.fire({
                    icon: "error",
                    title: "Invalid Message JSON",
                    text: `Please check your JSON input: ${error.message}`,
                });
            }
        }

        function sendSticker() {
            const packageId = document.getElementById("textBox1").value || "11537";
            const stickerId = document.getElementById("textBox2").value || "52002734";
            if (!isValidStickerMessage(packageId, stickerId)) {
                Swal.fire({
                    icon: "error",
                    title: "Invalid Sticker IDs",
                    text: "Please ensure packageId and stickerId are valid numbers.",
                });
                return;
            }
            const messageObj = {
                type: "sticker",
                packageId: packageId,
                stickerId: stickerId
            };
            sendMessage(messageObj);
        }

        function clearText() {
            Swal.fire({
                title: "คุณแน่ใจหรือไม่?",
                text: "คุณต้องการล้างข้อความทั้งหมดใช่หรือไม่?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "ใช่, ล้างข้อความ",
                cancelButtonText: "ยกเลิก",
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById("textBox1").value = "";
                    document.getElementById("textBox2").value = "";
                    document.getElementById("locationTitle").value = "";
                    document.getElementById("locationAddress").value = "";
                    document.getElementById("flex1").innerHTML = "";
                    document.getElementById("showtext").textContent = "";
                    document.getElementById("flex1").style.display = "none";
                    document.getElementById("showtext").style.display = "none";
                    document.getElementById("locationInputs").style.display = "none";
                    window.currentItemId = null;
                    if (map) {
                        map.remove();
                        map = null;
                    }
                    markers.forEach(m => map && map.removeLayer(m));
                    markers = [];
                    Swal.fire("ล้างข้อความแล้ว!", "ข้อความทั้งหมดถูกล้างและซ่อนเรียบร้อยแล้ว", "success");
                }
            });
        }

        function sendImage() {
            const originalContentUrl = document.getElementById("textBox1").value;
            const previewImageUrl = document.getElementById("textBox2").value;
            sendMessage({
                type: "image",
                originalContentUrl,
                previewImageUrl,
            });
        }

        function sendFlex() {
            const altText = document.getElementById("textBox1").value;
            let contents;
            try {
                contents = JSON.parse(document.getElementById("textBox2").value);
            } catch (e) {
                Swal.fire({
                    icon: "error",
                    title: "Invalid Flex Message format",
                    text: "Please check your JSON input.",
                });
                return;
            }
            if (!isValidFlexMessage(contents)) {
                Swal.fire({
                    icon: "error",
                    title: "Invalid Flex Message structure",
                    text: "Please ensure your JSON follows the correct Flex Message format.",
                });
                return;
            }
            const messageObj = {
                type: "flex",
                altText: altText || "Flex Message",
                contents: contents,
            };
            sendMessage(messageObj);
        }

        function sendVideo() {
            const originalContentUrl = document.getElementById("textBox1").value;
            const previewImageUrl = document.getElementById("textBox2").value;
            if (!originalContentUrl) {
                Swal.fire({
                    icon: "error",
                    title: "Missing video URL",
                    text: "Please enter a video URL in the first text box.",
                });
                return;
            }
            if (!previewImageUrl) {
                Swal.fire({
                    icon: "error",
                    title: "Missing preview image URL",
                    text: "Please enter a preview image URL in the second text box.",
                });
                return;
            }
            sendMessage({
                type: "video",
                originalContentUrl: originalContentUrl,
                previewImageUrl: previewImageUrl,
            });
        }

        function showVideo() {
            const videoUrl = document.getElementById("textBox1").value;
            const previewImageUrl = document.getElementById("textBox2").value;
            if (!videoUrl) {
                Swal.fire({
                    icon: "error",
                    title: "Missing video URL",
                    text: "Please enter a video URL in the first text box.",
                });
                return;
            }
            const videoPreview = document.getElementById("flex1");
            videoPreview.innerHTML = `
                <video width="100%" controls poster="${previewImageUrl}">
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            `;
        }

        function sendLocation() {
            const latitude = document.getElementById("textBox1").value.trim();
            const longitude = document.getElementById("textBox2").value.trim();
            const title = document.getElementById("locationTitle").value.trim() || "My Location";
            const address = document.getElementById("locationAddress").value.trim() || "View on map";
            if (!latitude || !longitude) {
                Swal.fire({
                    icon: "error",
                    title: "Missing location data",
                    text: "Please get your location first or enter latitude in textBox1 and longitude in textBox2.",
                });
                return;
            }
            const lat = parseFloat(latitude);
            const lon = parseFloat(longitude);
            if (isNaN(lat) || isNaN(lon)) {
                Swal.fire({
                    icon: "error",
                    title: "Invalid location data",
                    text: "Latitude and longitude must be valid numbers.",
                });
                return;
            }
            sendMessage({
                type: "location",
                title: title,
                address: address,
                latitude: lat,
                longitude: lon,
            });
        }

        async function scanQrCode() {
            const qrReader = document.getElementById("qr-reader");
            if (liff.isInClient()) {
                try {
                    const result = await liff.scanCodeV2();
                    document.getElementById("textBox2").value = result.value;
                    showScanResult(result.value);
                } catch (error) {
                    showScanError(error);
                }
            } else {
                qrReader.innerHTML = `
                    <div>
                        <p class="text-white" style="font-weight:bold; font-size:1rem;">เลือกวิธีสแกน QR Code:</p>
                        <button id="cameraBtn" class="btn btn-primary">ใช้กล้อง</button>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        <button id="fileBtn" class="btn btn-secondary">อัปโหลดรูปภาพ</button>
                    </div>
                    <div id="qrScannerContainer"></div>
                `;
                document.getElementById("cameraBtn").onclick = startCameraScanner;
                document.getElementById("fileBtn").onclick = () => document.getElementById("fileInput").click();
                document.getElementById("fileInput").onchange = handleFileUpload;
                qrReader.style.display = "block";
            }
        }

        let scanner = null;
        function startCameraScanner() {
            const qrScannerContainer = document.getElementById("qrScannerContainer");
            qrScannerContainer.innerHTML = "";
            scanner = new Html5Qrcode("qrScannerContainer");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            scanner
                .start({ facingMode: "environment" }, config, onScanSuccess, onScanError)
                .catch((error) => {
                    showCameraAccessInstructions();
                });
            const closeButton = document.createElement("button");
            closeButton.textContent = "ปิดสแกนเนอร์";
            closeButton.className = "btn btn-danger mt-2";
            closeButton.onclick = stopScanner;
            qrScannerContainer.appendChild(closeButton);
        }

        function stopScanner() {
            if (scanner) {
                scanner
                    .stop()
                    .then(() => {
                        scanner.clear();
                        document.getElementById("qrScannerContainer").innerHTML = "";
                    })
                    .catch((error) => {});
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0, img.width, img.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        if (code) {
                            onScanSuccess(code.data);
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "ไม่พบ QR Code",
                                text: "กรุณาอัปโหลดรูปภาพที่มี QR Code ที่ชัดเจน",
                            });
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function onScanSuccess(decodedText) {
            document.getElementById("textBox2").value = decodedText;
            showScanResult(decodedText);
            document.getElementById("qr-reader").style.display = "none";
        }

        function onScanError(error) {}

        function showCameraAccessInstructions() {
            Swal.fire({
                icon: "info",
                title: "ไม่สามารถเข้าถึงกล้องได้",
                html: `
                    <p>กรุณาทำตามขั้นตอนต่อไปนี้เพื่ออนุญาตการเข้าถึงกล้อง:</p>
                    <ol>
                        <li>คลิกที่ไอคอนกุญแจหรือ 'i' ที่ด้านซ้ายของ URL ในเบราว์เซอร์</li>
                        <li>เลือก 'การตั้งค่าไซต์' หรือ 'Site settings'</li>
                        <li>ค้นหาการตั้งค่ากล้องและเปลี่ยนเป็น 'อนุญาต' หรือ 'Allow'</li>
                        <li>รีเฟรชหน้าเว็บและลองสแกนอีกครั้ง</li>
                    </ol>
                    <p>หากยังไม่สามารถใช้กล้องได้ กรุณาลองอัปโหลดรูปภาพ QR Code แทน</p>
                `,
            });
        }

        function showScanResult(value) {
            Swal.fire({
                icon: "success",
                title: "สแกน QR Code สำเร็จ!",
                text: `ค่าที่สแกนได้: ${value}`,
                timer: 1500,
                showConfirmButton: false,
            });
        }

        function showScanError(error) {
            let errorMessage = "เกิดข้อผิดพลาดในการสแกน QR code";
            if (error.name === "NotAllowedError") {
                errorMessage = "ไม่ได้รับอนุญาตให้เข้าถึงกล้อง กรุณาอนุญาตการเข้าถึงกล้องเพื่อสแกน QR code";
            } else if (error.name === "NotFoundError") {
                errorMessage = "ไม่พบกล้องบนอุปกรณ์นี้";
            }
            Swal.fire({
                icon: "error",
                title: "เกิดข้อผิดพลาด",
                text: errorMessage,
            });
        }

        function clearInputs() {
            const textBox1 = document.getElementById("textBox1");
            const textBox2 = document.getElementById("textBox2");
            if (textBox1) textBox1.value = "";
            if (textBox2) textBox2.value = "";
            window.currentItemId = null;
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== "string") {
                return "";
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
