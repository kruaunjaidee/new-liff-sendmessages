<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LINE SHARE MESSAGE</title>
    <link rel="stylesheet" href="flex2html.css" />
    <script type="text/javascript" src="flex2html.min.js"></script>
    <style>
      body {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Arial", sans-serif;
      }
      .container {
        width: 100%;
        max-width: 600px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      #pictureUrl {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      }
      h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
      }
      .form-control {
        border-radius: 10px;
        border: 1px solid #ddd;
        padding: 12px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        width: 100%;
        box-sizing: border-box;
      }
      .form-control:focus {
        border-color: #2575fc;
        box-shadow: 0 0 0 0.2rem rgba(37, 117, 252, 0.25);
      }
      #flex1,
      #showtext {
        background-color: #fff;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .btn {
        border-radius: 50px;
        padding: 10px 20px;
        font-weight: bold;
        transition: all 0.3s ease;
        margin: 5px;
        color: white !important;
      }
      .btn-danger {
        background-color: #ff4757;
        border-color: #ff4757;
      }
      .btn-primary {
        background-color: #2575fc;
        border-color: #2575fc;
      }
      .btn-warning {
        background-color: #ffa502;
        border-color: #ffa502;
      }
      .btn-dark {
        background-color: #2f3542;
        border-color: #2f3542;
      }
      .btn-info {
        background-color: #70a1ff;
        border-color: #70a1ff;
      }
      .btn-outline-light {
        color: #fff;
        border-color: #fff;
        background-color: transparent;
      }
      .btn-outline-light:hover {
        background-color: #fff;
        color: #2575fc !important;
      }
      .btn-secondary {
        background-color: #747d8c;
        border-color: #747d8c;
      }
      .btn-success {
        background-color: #2ed573;
        border-color: #2ed573;
      }
      .btn-template {
        background-color: #00c4b4;
        border-color: #00c4b4;
      }
      .btn-sticker {
        background-color: #ff6b6b;
        border-color: #ff6b6b;
      }
      .btn-format {
        background-color: #28a745;
        border-color: #28a745;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      #dataList .card {
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
        margin-bottom: 15px;
      }
      #dataList .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      #dataList .card-body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 15px;
      }
      #dataList .card-title {
        color: #fff;
        font-size: 1.1rem;
        margin-bottom: 0;
      }
      #dataList .card-body a {
        color: #00c4b4;
        text-decoration: underline;
      }
      #dataList .card-body a:hover {
        color: #007bff;
      }
      #dataList .btn-group .btn {
        padding: 5px 10px;
        font-size: 0.9rem;
      }
      #template-preview img {
        max-width: 100%;
        border-radius: 10px;
        margin-bottom: 10px;
      }
      #template-preview .title {
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 5px;
      }
      #template-preview .text {
        margin-bottom: 10px;
      }
      #template-preview .action-link {
        display: block;
        margin: 5px 0;
        color: #00c4b4;
        text-decoration: underline;
      }
      #template-preview .action-link:hover {
        color: #007bff;
      }
      #template-preview .confirm-links {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      #template-preview .carousel {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding-bottom: 10px;
      }
      #template-preview .carousel-item {
        flex: 0 0 auto;
        width: 250px;
        background: #f5f5f5;
        border-radius: 10px;
        padding: 10px;
      }
      #template-preview .json-fallback {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9rem;
      }
      @media (max-width: 576px) {
        .container {
          padding: 20px;
        }
        h2 {
          font-size: 20px;
        }
        .btn {
          padding: 8px 16px;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container mt-3">
      <center>
        <img id="pictureUrl" class="mb-2" alt="Profile Picture" />
        <p class="text-white mb-2" id="displayName"></p>
        <p class="text-white mb-2" id="userId"></p>
        <p class="text-white mb-2" id="statusMessage"></p>
      </center>
      <h2 class="text-white text-center">❤️ ShareTargetPicker ❤️</h2>
      <div class="mb-3">
        <input
          class="form-control"
          type="text"
          id="textBox1"
          placeholder="ข้อมูลที่ 1 (เช่น packageId สำหรับ Sticker, หัวข้อสำหรับ Template)"
        />
      </div>
      <div class="mb-3">
        <textarea
          class="form-control"
          id="textBox2"
          placeholder="ข้อมูลที่ 2 (เช่น stickerId สำหรับ Sticker, JSON template สำหรับ Template)"
        ></textarea>
      </div>
      <div
        id="flex1"
        class="bg-white p-2 rounded mb-3"
        style="display: none"
      ></div>
      <div
        id="showtext"
        class="bg-white p-2 rounded mb-3"
        style="display: none"
      ></div>
      <div
        id="qr-reader"
        style="display: none; max-width: 300px; margin: 0 auto"
      ></div>
      <div class="d-flex flex-wrap justify-content-center">
        <button
          class="btn btn-danger"
          onclick="showFlex(); toggleMessageDisplay('flex1')"
        >
          Show Flex
        </button>
        <button class="btn btn-danger" onclick="sendFlex()">Send Flex</button>
        <button
          class="btn btn-primary"
          onclick="showImage(); toggleMessageDisplay('flex1')"
        >
          Show Img
        </button>
        <button class="btn btn-primary" onclick="sendImage()">Send Img</button>
        <button
          class="btn btn-warning"
          onclick="showText(); toggleMessageDisplay('showtext')"
        >
          Show Txt
        </button>
        <button class="btn btn-warning" onclick="sendText()">Send Text</button>
        <button class="btn btn-dark" onclick="showVideo()">Show Vid</button>
        <button class="btn btn-dark" onclick="sendVideo()">Send Vid</button>
        <button class="btn btn-info" onclick="getLocation()">Get Loc</button>
        <button class="btn btn-info" onclick="sendLocation()">Send Loc</button>
        <button class="btn btn-danger" onclick="scanQrCode()">
          Scan QR
        </button>
        <button
          class="btn btn-template"
          onclick="showTemplate(); toggleMessageDisplay('flex1')"
        >
          Show Template
        </button>
        <button class="btn btn-template" onclick="sendTemplate()">
          Send Template
        </button>
        <button
          class="btn btn-sticker"
          onclick="showSticker(); toggleMessageDisplay('flex1')"
        >
          Show Sticker
        </button>
        <button class="btn btn-sticker" onclick="sendSticker()">
          Send Sticker
        </button>
        <button class="btn btn-secondary" onclick="clearText()">
          ล้างข้อความทั้งหมด
        </button>
        <button class="btn btn-format" onclick="formatJson()">
          จัดรูปแบบ JSON
        </button>
        <button class="btn btn-outline-light" onclick="goSimulator()">
          Flex Simulator
        </button>
      </div>
      <div class="mt-3">
        <button class="btn btn-success w-100" onclick="saveToSupabase()">
          บันทึก Flex Message
        </button>
        <button class="btn btn-success w-100 mt-2 mb-3" onclick="saveTemplateToSupabase()">
          บันทึก Template Message
        </button>
      </div>
      <div id="dataList" class="mt-5 bg-white p-2 rounded"></div>
    </div>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
      const liffId = "2000563749-xo0QX4Ny";
      const SUPABASE_FUNCTIONS_URL = 'https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/submit-liff-shartargetpicker';
      let profile;
      window.listData = window.listData || [];
      window.currentItemId = null;

      liff
        .init({ liffId })
        .then(() => {
          if (liff.isLoggedIn()) {
            runApp();
          } else {
            liff.login();
          }
        })
        .catch((err) => {
          console.error("LIFF initialization failed:", err);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถเริ่มต้น LIFF ได้",
            text: err.message,
          });
        });

      function runApp() {
        liff.getProfile()
          .then((p) => {
            profile = p;
            const pictureUrl = document.getElementById("pictureUrl");
            const displayName = document.getElementById("displayName");
            const userId = document.getElementById("userId");
            const statusMessage = document.getElementById("statusMessage");
            if (pictureUrl) pictureUrl.src = profile.pictureUrl || "https://via.placeholder.com/80?text=No+Image";
            if (displayName) displayName.innerHTML = `<b>สวัสดี:</b> ${escapeHtml(profile.displayName || "Unknown User")}`;
            if (userId) userId.innerHTML = `<b>UserId:</b> ${escapeHtml(profile.userId || "N/A")}`;
            if (statusMessage) statusMessage.innerHTML = `<b>StatusMessage:</b> ${escapeHtml(profile.statusMessage || "No status")}`;
            fetchDataList();
          })
          .catch((err) => {
            console.error("Error getting LINE profile:", err);
            Swal.fire({
              icon: "error",
              title: "ไม่สามารถดึงข้อมูลโปรไฟล์ได้",
              text: err.message,
            });
          });
      }

      async function scanQrCode() {
        if (!liff.isInClient()) {
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถสแกน QR ได้",
            text: "ฟังก์ชันสแกน QR ใช้งานได้เฉพาะในแอป LINE เท่านั้น",
          });
          return;
        }
        try {
          const result = await liff.scanCodeV2();
          const textBox2 = document.getElementById("textBox2");
          if (textBox2) {
            textBox2.value = result.value;
            Swal.fire({
              position: "center",
              icon: "success",
              title: "สแกน QR เรียบร้อย !",
              text: `ค่าที่สแกนได้: ${result.value}`,
              showConfirmButton: false,
              timer: 1500,
            });
          } else {
            console.error("Element textBox2 not found");
            Swal.fire({
              icon: "error",
              title: "ข้อผิดพลาด",
              text: "ไม่พบช่องกรอกข้อมูลที่ 2",
            });
          }
        } catch (err) {
          console.error("Error scanning QR code:", err);
          Swal.fire({
            icon: "error",
            title: "เกิดข้อผิดพลาดในการสแกน QR",
            text: err.message,
          });
        }
      }

      function showFlex() {
        const flexContainer = document.getElementById("flex1");
        const flexJson = document.getElementById("textBox2").value.trim();
        if (!flexJson) {
          flexContainer.innerHTML = '<p class="text-danger">Please provide a valid Flex JSON in the second input.</p>';
          return;
        }
        flexContainer.innerHTML = "";
        try {
          const flexObject = JSON.parse(flexJson);
          if (!isValidFlexMessage(flexObject)) {
            throw new Error("Invalid Flex message structure");
          }
          const flexMessage = {
            type: "flex",
            altText: "Flex Message",
            contents: flexObject,
          };
          if (typeof flex2html === "function") {
            flex2html("flex1", flexMessage);
          } else {
            console.error("flex2html function is not available");
            flexContainer.innerHTML = '<p class="text-danger">flex2html library is not loaded properly.</p>';
          }
        } catch (err) {
          console.error("Error parsing Flex JSON:", err);
          flexContainer.innerHTML = `<p class="text-danger">Invalid Flex JSON: ${err.message}</p>`;
        }
      }

      function showText() {
        const showTextElement = document.getElementById("showtext");
        const text = document.getElementById("textBox2").value.trim();
        if (!showTextElement) {
          console.error("Element showtext not found");
          return;
        }
        showTextElement.textContent = text || "No text provided";
      }

      function showImage() {
        const flexContainer = document.getElementById("flex1");
        const src = document.getElementById("textBox2").value.trim();
        if (!src) {
          flexContainer.innerHTML = '<p class="text-danger">Please provide a valid image URL in the second input.</p>';
          return;
        }
        flexContainer.innerHTML = "";
        try {
          const img = document.createElement("img");
          img.src = src;
          img.setAttribute("width", "100%");
          img.onerror = () => {
            img.src = "https://via.placeholder.com/300?text=Image+Not+Found";
          };
          flexContainer.appendChild(img);
        } catch (err) {
          console.error("Error displaying image:", err);
          flexContainer.innerHTML = `<p class="text-danger">Error displaying image: ${err.message}</p>`;
        }
      }

      function sendTemplate() {
        const altText = document.getElementById("textBox1").value || "this is a template message";
        const templateJson = document.getElementById("textBox2").value.trim();
        if (!templateJson) {
          Swal.fire({
            icon: "error",
            title: "Missing Template JSON",
            text: "Please provide a valid Template JSON in the second input.",
          });
          return;
        }
        try {
          const template = JSON.parse(templateJson);
          console.log("Parsed template:", template);
          if (!isValidTemplateMessage(template)) {
            Swal.fire({
              icon: "error",
              title: "Invalid Template structure",
              text: "Please ensure your JSON has a valid 'type' field (buttons, confirm, carousel, or image_carousel).",
            });
            return;
          }
          const messageObj = {
            type: "template",
            altText: altText,
            template: template,
          };
          liff.ready.then(() => {
            liff.shareTargetPicker([messageObj])
              .then((result) => {
                if (result && result.status === "success") {
                  Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "ส่ง Template เรียบร้อย !",
                    showConfirmButton: false,
                    timer: 1500,
                  });
                  document.getElementById("textBox1").value = "";
                  document.getElementById("textBox2").value = "";
                  console.log("message sent");
                } else if (result && result.status === "cancel") {
                  Swal.fire({
                    icon: "info",
                    title: "คุณยกเลิกการแชร์",
                    timer: 1500,
                    showConfirmButton: false,
                  });
                } else {
                  console.warn("Unexpected shareTargetPicker result:", result);
                  Swal.fire({
                    icon: "info",
                    title: "การแชร์ถูกยกเลิกหรือไม่สำเร็จ",
                    timer: 1500,
                    showConfirmButton: false,
                  });
                }
              })
              .catch((err) => {
                console.error("Error sending template:", err);
                Swal.fire({
                  icon: "error",
                  title: "เกิดข้อผิดพลาดในการส่ง Template",
                  text: err.message,
                });
              });
          });
        } catch (err) {
          console.error("Error parsing Template JSON:", err);
          Swal.fire({
            icon: "error",
            title: "Invalid Template JSON",
            text: `Please check your JSON input: ${err.message}`,
          });
        }
      }

      function sendFlex() {
        const altText = document.getElementById("textBox1").value || "Flex Message";
        const flexJson = document.getElementById("textBox2").value.trim();
        if (!flexJson) {
          Swal.fire({
            icon: "error",
            title: "Missing Flex JSON",
            text: "Please provide a valid Flex JSON in the second input.",
          });
          return;
        }
        try {
          const contents = JSON.parse(flexJson);
          if (!isValidFlexMessage(contents)) {
            Swal.fire({
              icon: "error",
              title: "Invalid Flex Message structure",
              text: "Please ensure your JSON follows the correct Flex Message format.",
            });
            return;
          }
          const messageObj = {
            type: "flex",
            altText: altText,
            contents: contents,
          };
          liff.ready.then(() => {
            liff.shareTargetPicker([messageObj])
              .then((result) => {
                if (result && result.status === "success") {
                  Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "ส่ง Flex เรียบร้อย !",
                    showConfirmButton: false,
                    timer: 1500,
                  });
                  document.getElementById("textBox1").value = "";
                  document.getElementById("textBox2").value = "";
                  console.log("message sent");
                } else if (result && result.status === "cancel") {
                  Swal.fire({
                    icon: "info",
                    title: "คุณยกเลิกการแชร์",
                    timer: 1500,
                    showConfirmButton: false,
                  });
                } else {
                  console.warn("Unexpected shareTargetPicker result:", result);
                  Swal.fire({
                    icon: "info",
                    title: "การแชร์ถูกยกเลิกหรือไม่สำเร็จ",
                    timer: 1500,
                    showConfirmButton: false,
                  });
                }
              })
              .catch((err) => {
                console.error("Error sending Flex:", err);
                Swal.fire({
                  icon: "error",
                  title: "เกิดข้อผิดพลาดในการส่ง Flex",
                  text: err.message,
                });
              });
          });
        } catch (err) {
          console.error("Error parsing Flex JSON:", err);
          Swal.fire({
            icon: "error",
            title: "Invalid Flex JSON",
            text: `Please check your JSON input: ${err.message}`,
          });
        }
      }

      function sendText() {
        const text = document.getElementById("textBox2").value.trim();
        if (!text) {
          Swal.fire({
            icon: "error",
            title: "Missing Text",
            text: "Please provide text in the second input.",
          });
          return;
        }
        const messageObj = {
          type: "text",
          text: text,
        };
        liff.ready.then(() => {
          liff.shareTargetPicker([messageObj])
            .then((result) => {
              if (result && result.status === "success") {
                Swal.fire({
                  position: "center",
                  icon: "success",
                  title: "ส่งข้อความเรียบร้อย !",
                  showConfirmButton: false,
                  timer: 1500,
                });
                document.getElementById("textBox1").value = "";
                document.getElementById("textBox2").value = "";
                console.log("message sent");
              } else if (result && result.status === "cancel") {
                Swal.fire({
                  icon: "info",
                  title: "คุณยกเลิกการแชร์",
                  timer: 1500,
                  showConfirmButton: false,
                });
              } else {
                console.warn("Unexpected shareTargetPicker result:", result);
                Swal.fire({
                  icon: "info",
                  title: "การแชร์ถูกยกเลิกหรือไม่สำเร็จ",
                  timer: 1500,
                  showConfirmButton: false,
                });
              }
            })
            .catch((err) => {
              console.error("Error sending text:", err);
              Swal.fire({
                icon: "error",
                title: "เกิดข้อผิดพลาดในการส่งข้อความ",
                text: err.message,
              });
            });
        });
      }

      function sendImage() {
        const originalContentUrl = document.getElementById("textBox1").value.trim();
        const previewImageUrl = document.getElementById("textBox2").value.trim();
        if (!originalContentUrl || !previewImageUrl) {
          Swal.fire({
            icon: "error",
            title: "Missing Image URLs",
            text: "Please provide both original and preview image URLs.",
          });
          return;
        }
        const messageObj = {
          type: "image",
          originalContentUrl: originalContentUrl,
          previewImageUrl: previewImageUrl,
        };
        liff.ready.then(() => {
          liff.shareTargetPicker([messageObj])
            .then((result) => {
              if (result && result.status === "success") {
                Swal.fire({
                  position: "center",
                  icon: "success",
                  title: "ส่งภาพเรียบร้อย !",
                  showConfirmButton: false,
                  timer: 1500,
                });
                document.getElementById("textBox1").value = "";
                document.getElementById("textBox2").value = "";
                console.log("message sent");
              } else if (result && result.status === "cancel") {
                Swal.fire({
                  icon: "info",
                  title: "คุณยกเลิกการแชร์",
                  timer: 1500,
                  showConfirmButton: false,
                });
              } else {
                console.warn("Unexpected shareTargetPicker result:", result);
                Swal.fire({
                  icon: "info",
                  title: "การแชร์ถูกยกเลิกหรือไม่สำเร็จ",
                  timer: 1500,
                  showConfirmButton: false,
                });
              }
            })
            .catch((err) => {
              console.error("Error sending image:", err);
              Swal.fire({
                icon: "error",
                title: "เกิดข้อผิดพลาดในการส่งภาพ",
                text: err.message,
              });
            });
        });
      }

      function sendVideo() {
        const originalContentUrl = document.getElementById("textBox1").value.trim();
        const previewImageUrl = document.getElementById("textBox2").value.trim();
        if (!originalContentUrl || !previewImageUrl) {
          Swal.fire({
            icon: "error",
            title: "Missing Video URLs",
            text: "Please provide both video URL and preview image URL.",
          });
          return;
        }
        const messageObj = {
          type: "video",
          originalContentUrl: originalContentUrl,
          previewImageUrl: previewImageUrl,
        };
        liff.ready.then(() => {
          liff.shareTargetPicker([messageObj])
            .then((result) => {
              if (result && result.status === "success") {
                Swal.fire({
                  position: "center",
                  icon: "success",
                  title: "ส่งวิดีโอเรียบร้อย !",
                  showConfirmButton: false,
                  timer: 1500,
                });
                document.getElementById("textBox1").value = "";
                document.getElementById("textBox2").value = "";
                console.log("message sent");
              } else if (result && result.status === "cancel") {
                Swal.fire({
                  icon: "info",
                  title: "คุณยกเลิกการแชร์",
                  timer: 1500,
                  showConfirmButton: false,
                });
              } else {
                console.warn("Unexpected shareTargetPicker result:", result);
                Swal.fire({
                  icon: "info",
                  title: "การแชร์ถูกยกเลิกหรือไม่สำเร็จ",
                  timer: 1500,
                  showConfirmButton: false,
                });
              }
            })
            .catch((err) => {
              console.error("Error sending video:", err);
              Swal.fire({
                icon: "error",
                title: "เกิดข้อผิดพลาดในการส่งวิดีโอ",
                text: err.message,
              });
            });
        });
      }

      function sendLocation() {
        const latitude = document.getElementById("textBox1").value.trim();
        const longitude = document.getElementById("textBox2").value.trim();
        if (!latitude || !longitude || isNaN(parseFloat(latitude)) || isNaN(parseFloat(longitude))) {
          Swal.fire({
            icon: "error",
            title: "Invalid Location Data",
            text: "Please provide valid latitude and longitude values.",
          });
          return;
        }
        const messageObj = {
          type: "location",
          title: "คุณได้รับโลเคชั่น จากฉันแล้ว...",
          address: "ที่อยู่นี้สามารถดูได้จากแผนที่",
          latitude: parseFloat(latitude),
          longitude: parseFloat(longitude),
        };
        liff.ready.then(() => {
          liff.shareTargetPicker([messageObj])
            .then((result) => {
              if (result && result.status === "success") {
                Swal.fire({
                  position: "center",
                  icon: "success",
                  title: "ส่งโลเคชั่นเรียบร้อย !",
                  showConfirmButton: false,
                  timer: 1500,
                });
                document.getElementById("textBox1").value = "";
                document.getElementById("textBox2").value = "";
                console.log("message sent");
              } else if (result && result.status === "cancel") {
                Swal.fire({
                  icon: "info",
                  title: "คุณยกเลิกการแชร์",
                  timer: 1500,
                  showConfirmButton: false,
                });
              } else {
                console.warn("Unexpected shareTargetPicker result:", result);
                Swal.fire({
                  icon: "info",
                  title: "การแชร์ถูกยกเลิกหรือไม่สำเร็จ",
                  timer: 1500,
                  showConfirmButton: false,
                });
              }
            })
            .catch((err) => {
              console.error("Error sending location:", err);
              Swal.fire({
                icon: "error",
                title: "เกิดข้อผิดพลาดในการส่งโลเคชั่น",
                text: err.message,
              });
            });
        });
      }

      function goSimulator() {
        liff.openWindow({
          url: "https://developers.line.biz/flex-simulator/",
          external: true,
        });
      }

      function toggleMessageDisplay(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.style.display = element.style.display === "none" ? "block" : "none";
        } else {
          console.error(`Element ${elementId} not found`);
        }
      }

      function formatJson() {
        const textBox2 = document.getElementById("textBox2");
        const jsonInput = textBox2.value.trim();
        if (!jsonInput) {
          Swal.fire({
            icon: "error",
            title: "ไม่มี JSON ให้จัดรูปแบบ",
            text: "กรุณากรอก JSON ในช่องข้อมูลที่ 2",
          });
          return;
        }
        try {
          const jsonObj = JSON.parse(jsonInput);
          textBox2.value = JSON.stringify(jsonObj, null, 2);
          Swal.fire({
            icon: "success",
            title: "จัดรูปแบบ JSON สำเร็จ!",
            timer: 1000,
            showConfirmButton: false,
          });
        } catch (error) {
          console.error("Error formatting JSON:", error);
          Swal.fire({
            icon: "error",
            title: "JSON ไม่ถูกต้อง",
            text: `ไม่สามารถจัดรูปแบบได้: ${error.message}`,
          });
        }
      }

      function showTemplate() {
        const flexContainer = document.getElementById("flex1");
        const templateJson = document.getElementById("textBox2").value.trim();
        if (!templateJson) {
          flexContainer.innerHTML = '<p class="text-danger">Please provide a valid Template JSON in the second input.</p>';
          return;
        }
        try {
          const templateObject = JSON.parse(templateJson);
          if (!isValidTemplateMessage(templateObject)) {
            throw new Error("Invalid Template message structure: Must have a 'type' field");
          }
          if (templateObject.type === "buttons") {
            flexContainer.innerHTML = `
              <div id="template-preview">
                ${templateObject.thumbnailImageUrl ? `<img src="${templateObject.thumbnailImageUrl}" alt="Thumbnail" style="aspect-ratio: ${templateObject.imageAspectRatio || 'rectangle'}; object-fit: ${templateObject.imageSize || 'cover'}; background-color: ${templateObject.imageBackgroundColor || '#FFFFFF'};" onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=Thumbnail+Not+Found';">` : ''}
                ${templateObject.title ? `<div class="title">${escapeHtml(templateObject.title)}</div>` : ''}
                <div class="text">${escapeHtml(templateObject.text || '')}</div>
                ${templateObject.actions && Array.isArray(templateObject.actions) ? templateObject.actions.map(action => `
                  <a href="${action.uri || '#'}" target="_blank" class="action-link">${escapeHtml(action.label || 'Action')}</a>
                `).join('') : ''}
              </div>
            `;
          } else if (templateObject.type === "confirm") {
            flexContainer.innerHTML = `
              <div id="template-preview">
                <div class="text">${escapeHtml(templateObject.text || '')}</div>
                <div class="confirm-links">
                  ${templateObject.actions && Array.isArray(templateObject.actions) ? templateObject.actions.map(action => `
                    <a href="${action.uri || '#'}" target="_blank" class="action-link">${escapeHtml(action.label || 'Action')}</a>
                  `).join('') : ''}
                </div>
              </div>
            `;
          } else if (templateObject.type === "carousel") {
            flexContainer.innerHTML = `
              <div id="template-preview">
                <div class="carousel">
                  ${templateObject.columns && Array.isArray(templateObject.columns) ? templateObject.columns.map(column => `
                    <div class="carousel-item">
                      ${column.thumbnailImageUrl ? `<img src="${column.thumbnailImageUrl}" alt="Thumbnail" style="aspect-ratio: ${column.imageAspectRatio || 'rectangle'}; object-fit: ${column.imageSize || 'cover'}; background-color: ${column.imageBackgroundColor || '#FFFFFF'};" onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=Thumbnail+Not+Found';">` : ''}
                      ${column.title ? `<div class="title">${escapeHtml(column.title)}</div>` : ''}
                      <div class="text">${escapeHtml(column.text || '')}</div>
                      ${column.actions && Array.isArray(column.actions) ? column.actions.map(action => `
                        <a href="${action.uri || '#'}" target="_blank" class="action-link">${escapeHtml(action.label || 'Action')}</a>
                      `).join('') : ''}
                    </div>
                  `).join('') : ''}
                </div>
              </div>
            `;
          } else if (templateObject.type === "image_carousel") {
            flexContainer.innerHTML = `
              <div id="template-preview">
                <div class="carousel">
                  ${templateObject.columns && Array.isArray(templateObject.columns) ? templateObject.columns.map(column => `
                    <div class="carousel-item">
                      <img src="${column.imageUrl || 'https://via.placeholder.com/300?text=Image+Not+Found'}" alt="Image" style="object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=Image+Not+Found';">
                      <a href="${column.action && column.action.uri ? column.action.uri : '#'}" target="_blank" class="action-link">${escapeHtml(column.action && column.action.label ? column.action.label : 'Action')}</a>
                    </div>
                  `).join('') : ''}
                </div>
              </div>
            `;
          } else {
            flexContainer.innerHTML = `
              <div id="template-preview">
                <p>Unrecognized template type: ${escapeHtml(templateObject.type)}</p>
                <pre class="json-fallback">${escapeHtml(JSON.stringify(templateObject, null, 2))}</pre>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error parsing Template JSON:", error);
          flexContainer.innerHTML = `<p class="text-danger">Invalid Template JSON: ${error.message}</p>`;
        }
      }

      function isValidTemplateMessage(obj) {
        if (!obj || typeof obj !== "object" || !obj.type || typeof obj.type !== "string") {
          return false;
        }
        return ["buttons", "confirm", "carousel", "image_carousel"].includes(obj.type);
      }

      function isValidFlexMessage(obj) {
        return (
          obj &&
          (obj.type === "bubble" ||
            obj.type === "carousel" ||
            (obj.type === "flex" && obj.contents))
        );
      }

      function isValidStickerMessage(packageId, stickerId) {
        return packageId && stickerId && /^\d+$/.test(packageId) && /^\d+$/.test(stickerId);
      }

      function sendSticker() {
        const packageId = document.getElementById("textBox1").value || "11537";
        const stickerId = document.getElementById("textBox2").value || "52002734";
        if (!isValidStickerMessage(packageId, stickerId)) {
          Swal.fire({
            icon: "error",
            title: "Invalid Sticker IDs",
            text: "Please ensure packageId and stickerId are valid numbers.",
          });
          return;
        }
        const messageObj = {
          type: "sticker",
          packageId: packageId,
          stickerId: stickerId,
        };
        sendMessage(messageObj);
      }

      function clearText() {
        Swal.fire({
          title: "คุณแน่ใจหรือไม่?",
          text: "คุณต้องการล้างข้อความทั้งหมดใช่หรือไม่?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "ใช่, ล้างข้อความ",
          cancelButtonText: "ยกเลิก",
        }).then((result) => {
          if (result.isConfirmed) {
            document.getElementById("textBox1").value = "";
            document.getElementById("textBox2").value = "";
            document.getElementById("flex1").innerHTML = "";
            document.getElementById("showtext").textContent = "";
            document.getElementById("flex1").style.display = "none";
            document.getElementById("showtext").style.display = "none";
            window.currentItemId = null;
            Swal.fire("ล้างข้อความแล้ว!", "ข้อความทั้งหมดถูกล้างและซ่อนเรียบร้อยแล้ว", "success");
          }
        });
      }

      function showSticker() {
        const flexContainer = document.getElementById("flex1");
        flexContainer.innerHTML = "";
        const packageId = document.getElementById("textBox1").value || "11537";
        const stickerId = document.getElementById("textBox2").value || "52002734";
        const stickerUrl = `https://stickershop.line-scdn.net/stickershop/v1/sticker/${stickerId}/android/sticker.png`;
        flexContainer.innerHTML = `<img src="${stickerUrl}" alt="Sticker (packageId: ${packageId}, stickerId: ${stickerId})" style="max-width: 200px;" onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=Sticker+Not+Found';">`;
      }

      function showVideo() {
        const videoUrl = document.getElementById("textBox1").value.trim();
        const previewImageUrl = document.getElementById("textBox2").value.trim();
        if (!videoUrl) {
          Swal.fire({
            icon: "error",
            title: "Missing Video URL",
            text: "Please enter a video URL in the first text box.",
          });
          return;
        }
        const videoPreview = document.getElementById("flex1");
        videoPreview.innerHTML = `
          <video width="100%" controls poster="${previewImageUrl || 'https://via.placeholder.com/300?text=Preview+Not+Found'}">
            <source src="${videoUrl}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        `;
      }

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
          Swal.fire({
            icon: "error",
            title: "Geolocation not supported",
            text: "Your browser does not support geolocation.",
          });
        }
      }

      function showPosition(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        document.getElementById("textBox1").value = latitude;
        document.getElementById("textBox2").value = longitude;
        Swal.fire({
          icon: "success",
          title: "Location retrieved",
          text: `Latitude: ${latitude}, Longitude: ${longitude}`,
          timer: 2000,
          showConfirmButton: false,
        });
      }

      function showError(error) {
        let errorMessage;
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = "User denied the request for Geolocation.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = "Location information is unavailable.";
            break;
          case error.TIMEOUT:
            errorMessage = "The request to get user location timed out.";
            break;
          case error.UNKNOWN_ERROR:
            errorMessage = "An unknown error occurred.";
            break;
        }
        Swal.fire({
          icon: "error",
          title: "Error getting location",
          text: errorMessage,
        });
      }

      async function saveToSupabase(retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          Swal.fire({
            icon: "error",
            title: "โปรไฟล์ยังไม่โหลด",
            text: "กรุณารอสักครู่แล้วลองใหม่",
          });
          return;
        }
        const flexJson = document.getElementById("textBox2").value.trim();
        const title = document.getElementById("textBox1").value.trim();
        if (!title) {
          Swal.fire({
            icon: "error",
            title: "กรุณากรอกหัวข้อ",
            text: "หัวข้อไม่สามารถเป็นค่าว่างได้",
          });
          return;
        }
        let flexObj;
        try {
          flexObj = JSON.parse(flexJson);
          if (!isValidFlexMessage(flexObj)) {
            throw new Error("ไม่ใช่ Flex Message ที่ถูกต้อง");
          }
        } catch (error) {
          console.error("Error parsing Flex JSON:", error);
          Swal.fire({
            icon: "error",
            title: "JSON ไม่ถูกต้อง",
            text: `กรุณาตรวจสอบ JSON Flex Message ของคุณ: ${error.message}`,
          });
          return;
        }
        const data = {
          id: window.currentItemId || undefined,
          title: title,
          text1: flexJson,
          userId: profile.userId,
          displayName: profile.displayName,
          type: "flex",
        };
        Swal.fire({
          title: window.currentItemId ? "กำลังอัปเดตข้อมูล..." : "กำลังบันทึกข้อมูล...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        try {
          const method = window.currentItemId ? "PUT" : "POST";
          const response = await fetch(SUPABASE_FUNCTIONS_URL, {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${response.status}`;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${text}`;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${text}`;
            }
            throw new Error(errorMessage);
          }
          const result = await response.json();
          if (result.success) {
            Swal.fire({
              icon: "success",
              title: window.currentItemId ? "อัปเดตข้อมูลเรียบร้อย!" : "บันทึกข้อมูลเรียบร้อย!",
              timer: 1500,
              showConfirmButton: false,
            });
            window.currentItemId = null;
            clearInputs();
            fetchDataList();
          } else {
            throw new Error(result.error || "Unknown error occurred");
          }
        } catch (error) {
          console.error("Error saving data:", error);
          if (retryCount < maxRetries) {
            console.log(`Retrying saveToSupabase (${retryCount + 1}/${maxRetries})...`);
            setTimeout(() => saveToSupabase(retryCount + 1, maxRetries), 1000);
          } else {
            Swal.fire({
              icon: "error",
              title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
              text: error.message,
            });
          }
        }
      }

      async function saveTemplateToSupabase(retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          Swal.fire({
            icon: "error",
            title: "โปรไฟล์ยังไม่โหลด",
            text: "กรุณารอสักครู่แล้วลองใหม่",
          });
          return;
        }
        const templateJson = document.getElementById("textBox2").value.trim();
        const title = document.getElementById("textBox1").value.trim();
        if (!title) {
          Swal.fire({
            icon: "error",
            title: "กรุณากรอกหัวข้อ",
            text: "หัวข้อไม่สามารถเป็นค่าว่างได้",
          });
          return;
        }
        let templateObj;
        try {
          templateObj = JSON.parse(templateJson);
          if (!isValidTemplateMessage(templateObj)) {
            throw new Error("ไม่ใช่ Template Message ที่ถูกต้อง: ต้องมีฟิลด์ 'type'");
          }
        } catch (error) {
          console.error("Error parsing Template JSON:", error);
          Swal.fire({
            icon: "error",
            title: "JSON ไม่ถูกต้อง",
            text: `กรุณาตรวจสอบ JSON Template Message ของคุณ: ${error.message}`,
          });
          return;
        }
        const data = {
          id: window.currentItemId || undefined,
          title: title,
          text1: templateJson,
          userId: profile.userId,
          displayName: profile.displayName,
          type: "template",
        };
        Swal.fire({
          title: window.currentItemId ? "กำลังอัปเดตข้อมูล..." : "กำลังบันทึกข้อมูล...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        try {
          const method = window.currentItemId ? "PUT" : "POST";
          const response = await fetch(SUPABASE_FUNCTIONS_URL, {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${response.status}`;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${text}`;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${text}`;
            }
            throw new Error(errorMessage);
          }
          const result = await response.json();
          if (result.success) {
            Swal.fire({
              icon: "success",
              title: window.currentItemId ? "อัปเดตข้อมูลเรียบร้อย!" : "บันทึกข้อมูลเรียบร้อย!",
              timer: 1500,
              showConfirmButton: false,
            });
            window.currentItemId = null;
            clearInputs();
            fetchDataList();
          } else {
            throw new Error(result.error || "Unknown error occurred");
          }
        } catch (error) {
          console.error("Error saving data:", error);
          if (retryCount < maxRetries) {
            console.log(`Retrying saveTemplateToSupabase (${retryCount + 1}/${maxRetries})...`);
            setTimeout(() => saveTemplateToSupabase(retryCount + 1, maxRetries), 1000);
          } else {
            Swal.fire({
              icon: "error",
              title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
              text: error.message,
            });
          }
        }
      }

      async function fetchDataList(retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          console.warn("Profile not loaded yet, skipping fetchDataList");
          return;
        }
        try {
          const response = await fetch(`${SUPABASE_FUNCTIONS_URL}?userId=${encodeURIComponent(profile.userId)}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${response.status}`;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${text}`;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${text}`;
            }
            throw new Error(errorMessage);
          }
          const data = await response.json();
          window.listData = data;
          const listHtml = data
            .map((item) => {
              const title = escapeHtml(item.title || "");
              return `
                <div class="card" id="item-${item.id}">
                  <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <div class="btn-group">
                      <button class="btn btn-sm btn-primary" onclick="shareListItem('${item.id}')">แชร์</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteListItem('${item.id}')">ลบ</button>
                      <button class="btn btn-sm btn-info" onclick="showMessage('${item.id}')">แสดง</button>
                    </div>
                  </div>
                </div>
              `;
            })
            .join("");
          const dataListElement = document.getElementById("dataList");
          if (dataListElement) {
            dataListElement.innerHTML = listHtml || "<p>ไม่มีข้อมูล</p>";
          } else {
            console.error("Element with id 'dataList' not found");
          }
        } catch (error) {
          console.error("Error fetching data:", error);
          if (retryCount < maxRetries) {
            console.log(`Retrying fetchDataList (${retryCount + 1}/${maxRetries})...`);
            setTimeout(() => fetchDataList(retryCount + 1, maxRetries), 1000);
          } else {
            const dataListElement = document.getElementById("dataList");
            if (dataListElement) {
              dataListElement.innerHTML = `<p class="text-danger">Error loading data: ${error.message}</p>`;
            }
            Swal.fire({
              icon: "error",
              title: "ไม่สามารถโหลดข้อมูลได้",
              text: "กรุณาลองรีเฟรชหน้าเว็บ",
            });
          }
        }
      }

      async function showMessage(id, retryCount = 0, maxRetries = 1) {
        if (!window.listData || !Array.isArray(window.listData)) {
          console.warn("listData is not initialized, attempting to fetch...");
          if (retryCount < maxRetries) {
            await fetchDataList();
            return showMessage(id, retryCount + 1, maxRetries);
          }
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูลได้",
            text: "ไม่สามารถโหลดรายการข้อมูล กรุณารีเฟรชหน้าเว็บ",
            confirmButtonText: "รีเฟรช",
          }).then((result) => {
            if (result.isConfirmed) {
              fetchDataList();
            }
          });
          return;
        }
        const item = window.listData.find((item) => String(item.id) === String(id));
        if (!item) {
          console.error("showMessage: Item not found for id:", id);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแสดงข้อมูลได้",
            text: "ไม่พบรายการที่ร้องขอ กรุณารีเฟรชหน้าเว็บ",
            confirmButtonText: "รีเฟรช",
          }).then((result) => {
            if (result.isConfirmed) {
              fetchDataList();
            }
          });
          return;
        }
        if (!item.text1 || !item.type) {
          console.error("showMessage: Missing text1 or type for item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแสดงข้อมูลได้",
            text: "ข้อมูลข้อความไม่สมบูรณ์",
          });
          return;
        }
        document.getElementById("textBox1").value = item.title || "";
        document.getElementById("textBox2").value = item.text1;
        window.currentItemId = id;
        const flexContainer = document.getElementById("flex1");
        if (!flexContainer) {
          console.error("Flex container not found");
          Swal.fire({
            icon: "error",
            title: "ข้อผิดพลาด",
            text: "ไม่พบคอนเทนเนอร์สำหรับแสดงข้อความ",
          });
          return;
        }
        flexContainer.innerHTML = "";
        try {
          const obj = JSON.parse(item.text1);
          if (item.type === "flex") {
            if (!isValidFlexMessage(obj)) {
              throw new Error("Invalid Flex message structure");
            }
            let flexMessage;
            if (obj.type === "carousel" || obj.type === "bubble") {
              flexMessage = {
                type: "flex",
                altText: item.title || "Flex Message",
                contents: obj,
              };
            } else {
              flexMessage = obj;
            }
            if (typeof flex2html === "function") {
              flex2html("flex1", flexMessage);
              flexContainer.style.display = "block";
              flexContainer.classList.remove("bg-white", "p-2", "rounded");
              flexContainer.scrollIntoView({ behavior: "smooth" });
            } else {
              console.error("flex2html function is not available");
              flexContainer.innerHTML = '<p class="text-danger">flex2html library is not loaded properly.</p>';
            }
          } else if (item.type === "template") {
            if (!isValidTemplateMessage(obj)) {
              throw new Error("Invalid Template message structure: Must have a 'type' field");
            }
            if (obj.type === "buttons") {
              flexContainer.innerHTML = `
                <div id="template-preview">
                  ${obj.thumbnailImageUrl ? `<img src="${obj.thumbnailImageUrl}" alt="Thumbnail" style="aspect-ratio: ${obj.imageAspectRatio || 'rectangle'}; object-fit: ${obj.imageSize || 'cover'}; background-color: ${obj.imageBackgroundColor || '#FFFFFF'};" onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=Thumbnail+Not+Found';">` : ''}
                  ${obj.title ? `<div class="title">${escapeHtml(obj.title)}</div>` : ''}
                  <div class="text">${escapeHtml(obj.text || '')}</div>
                  ${obj.actions && Array.isArray(obj.actions) ? obj.actions.map((action) => `
                    <a href="${action.uri || '#'}" target="_blank" class="action-link">${escapeHtml(action.label || 'Action')}</a>
                  `).join('') : ''}
                </div>
              `;
            } else if (obj.type === "confirm") {
              flexContainer.innerHTML = `
                <div id="template-preview">
                  <div class="text">${escapeHtml(obj.text || '')}</div>
                  <div class="confirm-links">
                    ${obj.actions && Array.isArray(obj.actions) ? obj.actions.map((action) => `
                      <a href="${action.uri || '#'}" target="_blank" class="action-link">${escapeHtml(action.label || 'Action')}</a>
                    `).join('') : ''}
                  </div>
                </div>
              `;
            } else if (obj.type === "carousel") {
              flexContainer.innerHTML = `
                <div id="template-preview">
                  <div class="carousel">
                    ${obj.columns && Array.isArray(obj.columns) ? obj.columns.map((column) => `
                      <div class="carousel-item">
                        ${column.thumbnailImageUrl ? `<img src="${column.thumbnailImageUrl}" alt="Thumbnail" style="aspect-ratio: ${column.imageAspectRatio || 'rectangle'}; object-fit: ${column.imageSize || 'cover'}; background-color: ${column.imageBackgroundColor || '#FFFFFF'};" onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=Thumbnail+Not+Found';">` : ''}
                        ${column.title ? `<div class="title">${escapeHtml(column.title)}</div>` : ''}
                        <div class="text">${escapeHtml(column.text || '')}</div>
                        ${column.actions && Array.isArray(column.actions) ? column.actions.map((action) => `
                          <a href="${action.uri || '#'}" target="_blank" class="action-link">${escapeHtml(action.label || 'Action')}</a>
                        `).join('') : ''}
                      </div>
                    `).join('') : ''}
                  </div>
                </div>
              `;
            } else if (obj.type === "image_carousel") {
              flexContainer.innerHTML = `
                <div id="template-preview">
                  <div class="carousel">
                    ${obj.columns && Array.isArray(obj.columns) ? obj.columns.map((column) => `
                      <div class="carousel-item">
                        <img src="${column.imageUrl || 'https://via.placeholder.com/300?text=Image+Not+Found'}" alt="Image" style="object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=Image+Not+Found';">
                        <a href="${column.action && column.action.uri ? column.action.uri : '#'}" target="_blank" class="action-link">${escapeHtml(column.action && column.action.label ? column.action.label : 'Action')}</a>
                      </div>
                    `).join('') : ''}
                  </div>
                </div>
              `;
            } else {
              flexContainer.innerHTML = `
                <div id="template-preview">
                  <p>Unrecognized template type: ${escapeHtml(obj.type)}</p>
                  <pre class="json-fallback">${escapeHtml(JSON.stringify(obj, null, 2))}</pre>
                </div>
              `;
            }
            flexContainer.style.display = "block";
            flexContainer.scrollIntoView({ behavior: "smooth" });
          } else {
            throw new Error("Unknown message type");
          }
        } catch (e) {
          console.error("Error in showMessage:", e, "item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแสดงข้อความได้",
            text: `รูปแบบข้อมูลไม่ถูกต้อง: ${e.message}`,
          });
        }
      }

      async function deleteItemFromServer(id, retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          throw new Error("โปรไฟล์ยังไม่โหลด");
        }
        try {
          const response = await fetch(`${SUPABASE_FUNCTIONS_URL}?id=${encodeURIComponent(id)}&userId=${encodeURIComponent(profile.userId)}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${response.status}`;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${text}`;
            } else if (response.status === 403) {
              errorMessage = `Unauthorized: ${text}`;
            } else if (response.status === 404) {
              errorMessage = `Item not found: ${text}`;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${text}`;
            }
            throw new Error(errorMessage);
          }
          const data = await response.json();
          if (!data.success) {
            throw new Error(data.error || "Unknown error occurred");
          }
          return data;
        } catch (error) {
          if (retryCount < maxRetries) {
            console.log(`Retrying deleteItemFromServer (${retryCount + 1}/${maxRetries})...`);
            await new Promise((resolve) => setTimeout(resolve, 1000));
            return deleteItemFromServer(id, retryCount + 1, maxRetries);
          }
          throw error;
        }
      }

      function deleteListItem(id) {
        Swal.fire({
          title: "คุณแน่ใจหรือไม่?",
          text: "คุณไม่สามารถย้อนกลับการกระทำนี้ได้!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "ใช่, ลบเลย!",
          cancelButtonText: "ยกเลิก",
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire({
              title: "กำลังลบ...",
              text: "โปรดรอสักครู่",
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });
            deleteItemFromServer(id)
              .then(() => {
                Swal.fire("ลบแล้ว!", "รายการได้ถูกลบเรียบร้อยแล้ว", "success");
                fetchDataList();
                window.currentItemId = null;
              })
              .catch((error) => {
                console.error("Error deleting item:", error);
                Swal.fire(
                  "เกิดข้อผิดพลาด!",
                  `ไม่สามารถลบรายการได้: ${error.message}`,
                  "error"
                );
              });
          }
        });
      }

      function escapeHtml(unsafe) {
        if (typeof unsafe !== "string") {
          return "";
        }
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      async function shareListItem(id, retryCount = 0, maxRetries = 1) {
        if (!window.listData || !Array.isArray(window.listData)) {
          console.warn("listData is not initialized, attempting to fetch...");
          if (retryCount < maxRetries) {
            await fetchDataList();
            return shareListItem(id, retryCount + 1, maxRetries);
          }
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูลได้",
            text: "ไม่สามารถโหลดรายการข้อมูล กรุณารีเฟรชหน้าเว็บ",
            confirmButtonText: "รีเฟรช",
          }).then((result) => {
            if (result.isConfirmed) {
              fetchDataList();
            }
          });
          return;
        }
        const item = window.listData.find((item) => String(item.id) === String(id));
        if (!item) {
          console.error("shareListItem: Item not found for id:", id);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแชร์ข้อมูลได้",
            text: "ไม่พบรายการที่ร้องขอ กรุณารีเฟรชหน้าเว็บ",
            confirmButtonText: "รีเฟรช",
          }).then((result) => {
            if (result.isConfirmed) {
              fetchDataList();
            }
          });
          return;
        }
        if (!item.text1 || !item.type) {
          console.error("shareListItem: Missing text1 or type for item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแชร์ข้อมูลได้",
            text: "ข้อมูลข้อความไม่สมบูรณ์",
          });
          return;
        }
        try {
          const obj = JSON.parse(item.text1);
          let messageObj;
          if (item.type === "flex") {
            if (!isValidFlexMessage(obj)) {
              throw new Error("Invalid Flex message structure");
            }
            if (obj.type === "carousel" || obj.type === "bubble") {
              messageObj = {
                type: "flex",
                altText: item.title || "Flex Message",
                contents: obj,
              };
            } else {
              messageObj = obj;
            }
          } else if (item.type === "template") {
            if (!isValidTemplateMessage(obj)) {
              throw new Error("Invalid Template message structure: Must have a 'type' field");
            }
            messageObj = {
              type: "template",
              altText: item.title || "Template Message",
              template: obj,
            };
          } else {
            throw new Error("Unknown message type");
          }
          sendMessage(messageObj);
        } catch (e) {
          console.error("Error in shareListItem:", e, "item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถส่งข้อความได้",
            text: `รูปแบบข้อมูลไม่ถูกต้อง: ${e.message}`,
          });
        }
      }

      function sendMessage(messageObj) {
        liff.ready.then(() => {
          if (liff.isApiAvailable("shareTargetPicker")) {
            liff
              .shareTargetPicker([messageObj])
              .then((result) => {
                if (result && result.status === "success") {
                  Swal.fire({
                    icon: "success",
                    title: "ส่งข้อความเรียบร้อย!",
                    timer: 1500,
                    showConfirmButton: false,
                  });
                } else if (result && result.status === "cancel") {
                  Swal.fire({
                    icon: "info",
                    title: "คุณยกเลิกการแชร์",
                    timer: 1500,
                    showConfirmButton: false,
                  });
                } else {
                  console.warn("Unexpected shareTargetPicker result:", result);
                  Swal.fire({
                    icon: "info",
                    title: "การแชร์ถูกยกเลิกหรือไม่สำเร็จ",
                    timer: 1500,
                    showConfirmButton: false,
                  });
                }
              })
              .catch((error) => {
                console.error("Error sending message:", error);
                Swal.fire({
                  icon: "error",
                  title: "เกิดข้อผิดพลาดในการส่งข้อความ",
                  text: error.message,
                });
              });
          } else {
            Swal.fire({
              icon: "error",
              title: "ฟีเจอร์นี้ไม่รองรับ",
              text: "แอพพลิเคชันนี้ไม่รองรับการแชร์ข้อความ",
            });
          }
        });
      }

      function clearInputs() {
        const textBox1 = document.getElementById("textBox1");
        const textBox2 = document.getElementById("textBox2");
        if (textBox1) textBox1.value = "";
        if (textBox2) textBox2.value = "";
        window.currentItemId = null;
      }
    </script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </body>
</html>
