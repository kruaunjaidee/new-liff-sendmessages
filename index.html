<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINE Share Messages</title>
  <link rel="stylesheet" href="flex2html.css" />
  <script type="text/javascript" src="flex2html.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Arial", sans-serif;
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    #pictureUrl {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    h2 {
      color: #333;
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .form-control {
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }

    .form-control:focus {
      border-color: #2575fc;
      box-shadow: 0 0 0 0.2rem rgba(37, 117, 252, 0.25);
    }

    #flex1 {
      background-color: #839ebf;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    #showtext {
      background-color: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 200px;
      line-height: 1.5;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .btn {
      border-radius: 50px;
      padding: 10px 20px;
      font-weight: bold;
      transition: all 0.3s ease;
      margin: 5px;
      color: white !important;
    }

    .btn-danger {
      background-color: #ff4757;
      border-color: #ff4757;
    }

    .btn-primary {
      background-color: #2575fc;
      border-color: #2575fc;
    }

    .btn-warning {
      background-color: #ffa502;
      border-color: #ffa502;
    }

    .btn-dark {
      background-color: #2f3542;
      border-color: #2f3542;
    }

    .btn-info {
      background-color: #70a1ff;
      border-color: #70a1ff;
    }

    .btn-outline-light {
      color: #fff;
      border-color: #fff;
      background-color: transparent;
    }

    .btn-outline-light:hover {
      background-color: #fff;
      color: #2575fc !important;
    }

    .btn-secondary {
      background-color: #747d8c;
      border-color: #747d8c;
    }

    .btn-success {
      background-color: #2ed573;
      border-color: #2ed573;
    }

    .btn-template {
      background-color: #00c4b4;
      border-color: #00c4b4;
    }

    .btn-sticker {
      background-color: #ff6b6b;
      border-color: #ff6b6b;
    }

    .btn-imagemap {
      background-color: #e84393;
      border-color: #e84393;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #dataList .card {
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }

    #dataList .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    #dataList .card-body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
    }

    #dataList .card-title {
      color: #fff;
      font-size: 1.1rem;
      margin-bottom: 0;
    }

    #dataList .btn-group .btn {
      padding: 5px 10px;
      font-size: 0.9rem;
    }

    #template-preview img {
      max-width: 100%;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    #template-preview .title {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    #template-preview .text {
      margin-bottom: 10px;
    }

    #template-preview .action-btn {
      display: block;
      margin: 5px 0;
      padding: 10px;
      background-color: #00c4b4;
      color: white;
      text-align: center;
      border-radius: 5px;
      text-decoration: none;
    }

    pre {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }

    canvas {
      max-width: 100%;
      border-radius: 10px;
    }

    @media (max-width: 576px) {
      .container {
        padding: 20px;
      }

      h2 {
        font-size: 20px;
      }

      .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <div class="container mt-3">
    <center>
      <img id="pictureUrl" class="mb-2" alt="Profile Picture" />
      <p class="text-white mb-2" id="displayName"></p>
    </center>
    <h2 class="text-white text-center">❤️ SendMessage ❤️</h2>
    <div class="mb-3">
      <input class="form-control" type="text" id="textBox1"
        placeholder="ข้อมูลที่ 1 (เช่น หัวข้อสำหรับ Flex/Template/Imagemap)" />
    </div>
    <div class="mb-3">
      <textarea class="form-control" id="textBox2"
        placeholder="ข้อมูลที่ 2 (เช่น JSON สำหรับ Flex/Template/Imagemap)"></textarea>
    </div>
    <div id="flex1" class="bg-white p-2 rounded mb-3" style="display: none"></div>
    <div id="showtext" class="bg-white p-2 rounded mb-3" style="display: none"></div>
    <div id="qr-reader" style="display: none; max-width: 300px; margin: 0 auto"></div>
    <div class="d-flex flex-wrap justify-content-center">
      <button class="btn btn-danger" onclick="showFlex(); toggleMessageDisplay('flex1')">
        Show Flex
      </button>
      <button class="btn btn-danger" onclick="sendFlex()">Send Flex</button>
      <button class="btn btn-primary" onclick="showImage(); toggleMessageDisplay('flex1')">
        Show Img
      </button>
      <button class="btn btn-primary" onclick="sendImage()">Send Img</button>
      <button class="btn btn-warning" onclick="showText(); toggleMessageDisplay('showtext')">
        Show Txt
      </button>
      <button class="btn btn-warning" onclick="sendText()">Send Text</button>
      <button class="btn btn-dark" onclick="showVideo()">Show Vid</button>
      <button class="btn btn-dark" onclick="sendVideo()">Send Vid</button>
      <button class="btn btn-info" onclick="getLocation()">Get Loc</button>
      <button class="btn btn-info" onclick="sendLocation()">Send Loc</button>
      <button class="btn btn-danger" onclick="scanQrCode()">
        Scan QR
      </button>
      <button class="btn btn-template" onclick="showTemplate(); toggleMessageDisplay('flex1')">Show Template</button>
        Show Template
      </button>
      <button class="btn btn-template" onclick="sendTemplate()">
        Send Template
      </button>
      <button class="btn btn-sticker" onclick="showSticker(); toggleMessageDisplay('flex1')">
        Show Sticker
      </button>
      <button class="btn btn-sticker" onclick="sendSticker()">
        Send Sticker
      </button>
      <button class="btn btn-imagemap" onclick="showImagemap(); toggleMessageDisplay('flex1')">
        Show Imagemap
      </button>
      <button class="btn btn-imagemap" onclick="sendImagemap()">
        Send Imagemap
      </button>
      <button class="btn btn-secondary" onclick="formatJson()">
        Format JSON
      </button>
      <button class="btn btn-secondary" onclick="clearText()">
        ล้างข้อความทั้งหมด
      </button>
    </div>
    <div class="mt-3 mb-3">
      <button class="btn btn-success w-100" onclick="saveToSupabase()">
        บันทึก Flex Message
      </button>
      <button class="btn btn-success w-100 mt-2" onclick="saveTemplateToSupabase()">
        บันทึก Template Message
      </button>
      <button class="btn btn-success w-100 mt-2" onclick="saveImagemapToSupabase()">
        บันทึก Imagemap Message
      </button>
    </div>
    <div style="margin-top: 10px;" id="dataList" class="mt-3 bg-white p-2 rounded"></div>
  </div>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
  
    const liffId = "2005780370-QmwJlX9q";
    const SUPABASE_FUNCTIONS_URL = 'https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/submit-liff-shartargetpicker';
    let profile;
    window.listData = window.listData || [];
    let jsonIndentLevel = 4;

    liff
      .init({ liffId })
      .then(() => {
        if (liff.isLoggedIn()) {
          liff.getProfile().then((p) => {
            profile = p;
            document.getElementById("pictureUrl").src = profile.pictureUrl;
            document.getElementById("displayName").textContent = `สวัสดี: ${profile.displayName}`;
            fetchDataList();
          }).catch((err) => {
            console.error("Error getting LINE profile:", err);
            Swal.fire({
              icon: "error",
              title: "ไม่สามารถดึงข้อมูลโปรไฟล์ได้",
              text: err.message,
            });
          });
        } else {
          liff.login();
        }
      })
      .catch((err) => {
        console.error("LIFF initialization failed:", err);
        Swal.fire({
          icon: "error",
          title: "ไม่สามารถเริ่มต้น LIFF ได้",
          text: err.message,
        });
      });

    function toggleMessageDisplay(elementId) {
      const element = document.getElementById(elementId);
      element.style.display = element.style.display === "none" ? "block" : "none";
    }

    function showImage() {
      const src = document.getElementById("textBox2").value;
      document.getElementById("flex1").innerHTML = `<img width="100%" src="${src}" alt="Shared Image">`;
    }

    function showFlex() {
      const flexContainer = document.getElementById("flex1");
      flexContainer.innerHTML = "";
      try {
        const flexJson = document.getElementById("textBox2").value;
        const flexObject = JSON.parse(flexJson);
        const flexMessage = {
          type: "flex",
          altText: "Flex Message",
          contents: flexObject,
        };
        if (typeof flex2html === "function") {
          flex2html("flex1", flexMessage);
        } else {
          console.error("flex2html function is not available");
          flexContainer.innerHTML = '<p class="text-danger">flex2html library is not loaded properly.</p>';
        }
      } catch (error) {
        console.error("Error parsing Flex JSON:", error);
        flexContainer.innerHTML = '<p class="text-danger">Invalid Flex JSON. Please check your input.</p>';
      }
    }

    function showText() {
      const showTextElement = document.getElementById("showtext");
      showTextElement.textContent = document.getElementById("textBox2").value;
    }

    function showSticker() {
      const flexContainer = document.getElementById("flex1");
      flexContainer.innerHTML = "";
      const packageId = document.getElementById("textBox1").value || "11537";
      const stickerId = document.getElementById("textBox2").value || "52002734";
      const stickerUrl = `https://stickershop.line-scdn.net/stickershop/v1/sticker/${stickerId}/android/sticker.png`;
      flexContainer.innerHTML = `<img src="${stickerUrl}" alt="Sticker (packageId: ${packageId}, stickerId: ${stickerId})" style="max-width: 200px;" onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=Sticker+Not+Found';">`;
    }

    function showTemplate() {
      const flexContainer = document.getElementById("flex1");
      if (!flexContainer) {
        console.error("flex1 element not found");
        Swal.fire({
          icon: "error",
          title: "ข้อผิดพลาด",
          text: "ไม่พบคอนเทนเนอร์สำหรับแสดงข้อความ",
        });
        return;
      }
      flexContainer.innerHTML = "";
      const templateJson = document.getElementById("textBox2").value.trim();
      if (!templateJson) {
        flexContainer.innerHTML = '<p class="text-danger">กรุณาใส่ JSON ที่ถูกต้องในช่องที่สอง</p>';
        flexContainer.style.display = "block";
        return;
      }
      try {
        const templateObject = JSON.parse(templateJson);
        const formattedJson = JSON.stringify(templateObject, null, jsonIndentLevel);
        const jsonContainer = document.createElement("div");
        jsonContainer.style.whiteSpace = "pre-wrap";
        jsonContainer.style.backgroundColor = "#f8f9fa";
        jsonContainer.style.padding = "10px";
        jsonContainer.style.borderRadius = "5px";
        jsonContainer.style.overflowX = "auto";
        jsonContainer.style.margin = "0";
        jsonContainer.textContent = formattedJson;
        flexContainer.appendChild(jsonContainer);
        flexContainer.style.display = "block";
      } catch (error) {
        console.error("Error parsing JSON in showTemplate:", error);
        flexContainer.innerHTML = '<p class="text-danger">JSON ไม่ถูกต้อง กรุณาตรวจสอบข้อมูลที่ป้อน: ' + error.message + '</p>';
        flexContainer.style.display = "block";
      }
    }

    
    function showImagemap() {
      const flexContainer = document.getElementById("flex1");
      flexContainer.innerHTML = "";
      const imagemapJson = document.getElementById("textBox2").value.trim();
      if (!imagemapJson) {
        flexContainer.innerHTML = '<p class="text-danger">Please provide a valid JSON in the second input.</p>';
        return;
      }
      try {
        const imagemapObject = JSON.parse(imagemapJson);
        if (imagemapObject.type !== "imagemap") {
          throw new Error("JSON must have type: 'imagemap'");
        }
        renderImagemap(imagemapObject, flexContainer);
      } catch (error) {
        console.error("Error parsing Imagemap JSON:", error);
        flexContainer.innerHTML = '<p class="text-danger">Invalid JSON. Please check your input.</p>';
      }
    }

    function renderImagemap(imagemapObject, container) {
      const { baseUrl, baseSize, actions } = imagemapObject;
      if (!baseUrl || !baseSize || !baseSize.width || !baseSize.height || !actions) {
        container.innerHTML = '<p class="text-danger">Invalid Imagemap structure.</p>';
        return;
      }
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = baseSize.width;
      canvas.height = baseSize.height;
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = () => {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        actions.forEach((action, index) => {
          if (action.area) {
            const { x, y, width, height } = action.area;
            ctx.strokeStyle = `rgba(${index * 50 % 255}, ${index * 100 % 255}, ${255 - index * 50 % 255}, 0.8)`;
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            ctx.fillStyle = `rgba(${index * 50 % 255}, ${index * 100 % 255}, ${255 - index * 50 % 255}, 0.3)`;
            ctx.fillRect(x, y, width, height);
            ctx.fillStyle = "white";
            ctx.font = "16px Arial";
            ctx.fillText(action.type === "uri" ? "Link" : "Text", x + 10, y + 30);
          }
        });
      };
      img.onerror = () => {
        container.innerHTML = '<p class="text-danger">Failed to load image. Please check the baseUrl.</p>';
      };
      img.src = baseUrl;
      container.appendChild(canvas);
    }

    function formatJson() {
      const textBox2 = document.getElementById("textBox2");
      const jsonString = textBox2.value.trim();
      if (!jsonString) {
        Swal.fire({
          icon: "error",
          title: "No JSON to format",
          text: "Please provide a JSON string in the second input.",
        });
        return;
      }
      try {
        const jsonObj = JSON.parse(jsonString);
        jsonIndentLevel = jsonIndentLevel === 2 ? 4 : jsonIndentLevel === 4 ? 0 : 2;
        const indentLabel = jsonIndentLevel === 0 ? "minified" : `${jsonIndentLevel} spaces`;
        textBox2.value = JSON.stringify(jsonObj, null, jsonIndentLevel);
        Swal.fire({
          icon: "success",
          title: "JSON Formatted",
          text: `Formatted with ${indentLabel} indentation.`,
          timer: 1500,
          showConfirmButton: false,
        });
      } catch (error) {
        console.error("Error formatting JSON:", error);
        Swal.fire({
          icon: "error",
          title: "Invalid JSON",
          text: `Please check your JSON input: ${error.message}`,
        });
      }
    }

    function isValidStickerMessage(packageId, stickerId) {
      return packageId && stickerId && /^\d+$/.test(packageId) && /^\d+$/.test(stickerId);
    }

    function sendTemplate() {
      const templateJson = document.getElementById("textBox2").value.trim();
      if (!templateJson) {
        Swal.fire({
          icon: "error",
          title: "Missing Message JSON",
          text: "Please provide a valid JSON in the second input.",
        });
        return;
      }
      try {
        const messageObj = JSON.parse(templateJson);
        sendMessage(messageObj);
      } catch (error) {
        console.error("Error parsing Message JSON:", error);
        Swal.fire({
          icon: "error",
          title: "Invalid Message JSON",
          text: `Please check your JSON input: ${error.message}`,
        });
      }
    }

    function sendSticker() {
      const packageId = document.getElementById("textBox1").value || "11537";
      const stickerId = document.getElementById("textBox2").value || "52002734";
      if (!isValidStickerMessage(packageId, stickerId)) {
        Swal.fire({
          icon: "error",
          title: "Invalid Sticker IDs",
          text: "Please ensure packageId and stickerId are valid numbers.",
        });
        return;
      }
      const messageObj = {
        type: "sticker",
        packageId: packageId,
        stickerId: stickerId
      };
      sendMessage(messageObj);
    }

    function sendImagemap() {
      const imagemapJson = document.getElementById("textBox2").value.trim();
      if (!imagemapJson) {
        Swal.fire({
          icon: "error",
          title: "Missing Imagemap JSON",
          text: "Please provide a valid JSON in the second input.",
        });
        return;
      }
      try {
        const messageObj = JSON.parse(imagemapJson);
        if (messageObj.type !== "imagemap") {
          throw new Error("JSON must have type: 'imagemap'");
        }
        sendMessage(messageObj);
      } catch (error) {
        console.error("Error parsing Imagemap JSON:", error);
        Swal.fire({
          icon: "error",
          title: "Invalid Imagemap JSON",
          text: `Please check your JSON input: ${error.message}`,
        });
      }
    }

    function clearText() {
      Swal.fire({
        title: "คุณแน่ใจหรือไม่?",
        text: "คุณต้องการล้างข้อความทั้งหมดใช่หรือไม่?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ใช่, ล้างข้อความ",
        cancelButtonText: "ยกเลิก",
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById("textBox1").value = "";
          document.getElementById("textBox2").value = "";
          document.getElementById("flex1").innerHTML = "";
          document.getElementById("showtext").textContent = "";
          document.getElementById("flex1").style.display = "none";
          document.getElementById("showtext").style.display = "none";
          Swal.fire("ล้างข้อความแล้ว!", "ข้อความทั้งหมดถูกล้างและซ่อนเรียบร้อยแล้ว", "success");
        }
      });
    }

    function sendImage() {
      const originalContentUrl = document.getElementById("textBox1").value;
      const previewImageUrl = document.getElementById("textBox2").value;
      sendMessage({
        type: "image",
        originalContentUrl,
        previewImageUrl,
      });
    }

    function sendFlex() {
      const altText = document.getElementById("textBox1").value;
      let contents;
      try {
        contents = JSON.parse(document.getElementById("textBox2").value);
      } catch (e) {
        console.error("Error parsing Flex JSON:", e);
        Swal.fire({
          icon: "error",
          title: "Invalid Flex Message format",
          text: "Please check your JSON input.",
        });
        return;
      }
      if (!isValidFlexMessage(contents)) {
        Swal.fire({
          icon: "error",
          title: "Invalid Flex Message structure",
          text: "Please ensure your JSON follows the correct Flex Message format.",
        });
        return;
      }
      const messageObj = {
        type: "flex",
        altText: altText || "Flex Message",
        contents: contents,
      };
      sendMessage(messageObj);
    }

    function isValidFlexMessage(obj) {
      return (
        obj &&
        (obj.type === "bubble" ||
          obj.type === "carousel" ||
          (obj.type === "flex" && obj.contents))
      );
    }

    function sendText() {
      sendMessage({
        type: "text",
        text: document.getElementById("textBox2").value,
      });
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        Swal.fire({
          icon: "error",
          title: "Geolocation not supported",
          text: "Your browser does not support geolocation.",
        });
      }
    }

    function showPosition(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      document.getElementById("textBox1").value = latitude;
      document.getElementById("textBox2").value = longitude;
      Swal.fire({
        icon: "success",
        title: "Location retrieved",
        text: `Latitude: ${latitude}, Longitude: ${longitude}`,
        timer: 2000,
        showConfirmButton: false,
      });
    }

    function showError(error) {
      let errorMessage;
      switch (error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = "User denied the request for Geolocation.";
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage = "Location information is unavailable.";
          break;
        case error.TIMEOUT:
          errorMessage = "The request to get user location timed out.";
          break;
        case error.UNKNOWN_ERROR:
          errorMessage = "An unknown error occurred.";
          break;
      }
      Swal.fire({
        icon: "error",
        title: "Error getting location",
        text: errorMessage,
      });
    }

    function showVideo() {
      const videoUrl = document.getElementById("textBox1").value;
      const previewImageUrl = document.getElementById("textBox2").value;
      
      console.log("Video URL:", videoUrl); // Debug
      
      if (!videoUrl) {
        Swal.fire({
          icon: "error",
          title: "Missing video URL",
          text: "Please enter a video URL in the first text box.",
        });
        return;
      }
      
      const videoPreview = document.getElementById("flex1");
      console.log("Video Preview Element:", videoPreview); // Debug
      
      if (!videoPreview) {
        console.error("Element with ID 'flex1' not found!");
        return;
      }
      
      videoPreview.innerHTML = `
        <video width="100%" controls src="${videoUrl}" onloadstart="console.log('Video loading started')" onerror="console.error('Video failed to load')">
          Your browser does not support the video tag.
        </video>
      `;
    }
      function sendVideo() {
        const originalContentUrl = document.getElementById("textBox1").value;
        const previewImageUrl = document.getElementById("textBox2").value;
        if (!originalContentUrl) {
          Swal.fire({
            icon: "error",
            title: "Missing video URL",
            text: "Please enter a video URL in the first text box.",
          });
          return;
        }
        if (!previewImageUrl) {
          Swal.fire({
            icon: "error",
            title: "Missing preview image URL",
            text: "Please enter a preview image URL in the second text box.",
          });
          return;
        }
        sendMessage({
          type: "video",
          originalContentUrl: originalContentUrl,
          previewImageUrl: previewImageUrl,
        });
      }

      function sendLocation() {
        const latitude = document.getElementById("textBox1").value;
        const longitude = document.getElementById("textBox2").value;
        if (!latitude || !longitude) {
          Swal.fire({
            icon: "error",
            title: "Missing location data",
            text: "Please get your location first or enter latitude and longitude manually.",
          });
          return;
        }
        sendMessage({
          type: "location",
          title: "My Location",
          address: "View on map",
          latitude: parseFloat(latitude),
          longitude: parseFloat(longitude),
        });
      }

      async function scanQrCode() {
        const qrReader = document.getElementById("qr-reader");
        if (liff.isInClient()) {
          try {
            const result = await liff.scanCodeV2();
            document.getElementById("textBox2").value = result.value;
            showScanResult(result.value);
          } catch (error) {
            showScanError(error);
          }
        } else {
          qrReader.innerHTML = `
            <div>
              <p class="text-white" style="font-weight:bold; font-size:1rem;">เลือกวิธีสแกน QR Code:</p>
              <button id="cameraBtn" class="btn btn-primary">ใช้กล้อง</button>
              <input type="file" id="fileInput" accept="image/*" style="display: none;">
              <button id="fileBtn" class="btn btn-secondary">อัปโหลดรูปภาพ</button>
            </div>
            <div id="qrScannerContainer"></div>
      `;
          document.getElementById("cameraBtn").onclick = startCameraScanner;
          document.getElementById("fileBtn").onclick = () => document.getElementById("fileInput").click();
          document.getElementById("fileInput").onchange = handleFileUpload;
          qrReader.style.display = "block";
        }
      }

      let scanner = null;
      function startCameraScanner() {
        const qrScannerContainer = document.getElementById("qrScannerContainer");
        qrScannerContainer.innerHTML = "";
        scanner = new Html5Qrcode("qrScannerContainer");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        scanner
          .start({ facingMode: "environment" }, config, onScanSuccess, onScanError)
          .catch((error) => {
            console.error("Error starting scanner:", error);
            showCameraAccessInstructions();
          });
        const closeButton = document.createElement("button");
        closeButton.textContent = "ปิดสแกนเนอร์";
        closeButton.className = "btn btn-danger mt-2";
        closeButton.onclick = stopScanner;
        qrScannerContainer.appendChild(closeButton);
      }

      function stopScanner() {
        if (scanner) {
          scanner
            .stop()
            .then(() => {
              scanner.clear();
              document.getElementById("qrScannerContainer").innerHTML = "";
            })
            .catch((error) => console.error("Error stopping scanner:", error));
        }
      }

      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement("canvas");
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, img.width, img.height);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);
              if (code) {
                onScanSuccess(code.data);
              } else {
                Swal.fire({
                  icon: "error",
                  title: "ไม่พบ QR Code",
                  text: "กรุณาอัปโหลดรูปภาพที่มี QR Code ที่ชัดเจน",
                });
              }
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      }

      function onScanSuccess(decodedText) {
        document.getElementById("textBox2").value = decodedText;
        showScanResult(decodedText);
        document.getElementById("qr-reader").style.display = "none";
      }

      function onScanError(error) {
        console.warn(`QR error: ${ error } `);
      }

      function showCameraAccessInstructions() {
        Swal.fire({
          icon: "info",
          title: "ไม่สามารถเข้าถึงกล้องได้",
          html: `
        < p > กรุณาทำตามขั้นตอนต่อไปนี้เพื่ออนุญาตการเข้าถึงกล้อง:</p >
            <ol>
              <li>คลิกที่ไอคอนกุญแจหรือ 'i' ที่ด้านซ้ายของ URL ในเบราว์เซอร์</li>
              <li>เลือก 'การตั้งค่าไซต์' หรือ 'Site settings'</li>
              <li>ค้นหาการตั้งค่ากล้องและเปลี่ยนเป็น 'อนุญาต' หรือ 'Allow'</li>
              <li>รีเฟรชหน้าเว็บและลองสแกนอีกครั้ง</li>
            </ol>
            <p>หากยังไม่สามารถใช้กล้องได้ กรุณาลองอัปโหลดรูปภาพ QR Code แทน</p>
      `,
        });
      }

      function showScanResult(value) {
        Swal.fire({
          icon: "success",
          title: "สแกน QR Code สำเร็จ!",
          text: `ค่าที่สแกนได้: ${ value } `,
          timer: 1500,
          showConfirmButton: false,
        });
      }

      function showScanError(error) {
        let errorMessage = "เกิดข้อผิดพลาดในการสแกน QR code";
        if (error.name === "NotAllowedError") {
          errorMessage = "ไม่ได้รับอนุญาตให้เข้าถึงกล้อง กรุณาอนุญาตการเข้าถึงกล้องเพื่อสแกน QR code";
        } else if (error.name === "NotFoundError") {
          errorMessage = "ไม่พบกล้องบนอุปกรณ์นี้";
        }
        Swal.fire({
          icon: "error",
          title: "เกิดข้อผิดพลาด",
          text: errorMessage,
        });
      }

      async function saveToSupabase(retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          Swal.fire({
            icon: "error",
            title: "โปรไฟล์ยังไม่โหลด",
            text: "กรุณารอสักครู่แล้วลองใหม่",
          });
          return;
        }
        const flexJson = document.getElementById("textBox2").value;
        const title = document.getElementById("textBox1").value;
        if (!title.trim()) {
          Swal.fire({
            icon: "error",
            title: "กรุณากรอกหัวข้อ",
            text: "หัวข้อไม่สามารถเป็นค่าว่างได้",
          });
          return;
        }
        let flexObj;
        try {
          flexObj = JSON.parse(flexJson);
          if (!isValidFlexMessage(flexObj)) {
            throw new Error("ไม่ใช่ Flex Message ที่ถูกต้อง");
          }
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "JSON ไม่ถูกต้อง",
            text: `กรุณาตรวจสอบ JSON Flex Message ของคุณ: ${ error.message } `,
          });
          return;
        }
        const data = {
          title: title,
          text1: flexJson,
          userId: profile.userId,
          displayName: profile.displayName,
          type: "flex"
        };
        Swal.fire({
          title: "กำลังบันทึกข้อมูล...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        try {
          const response = await fetch(SUPABASE_FUNCTIONS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${ response.status } `;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${ text } `;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${ text } `;
            }
            throw new Error(errorMessage);
          }
          const result = await response.json();
          if (result.success) {
            Swal.fire({
              icon: "success",
              title: "บันทึกข้อมูลเรียบร้อย!",
              timer: 1500,
              showConfirmButton: false,
            });
            clearInputs();
            fetchDataList();
          } else {
            throw new Error(result.error || "Unknown error occurred");
          }
        } catch (error) {
          console.error("Error saving data:", error);
          if (retryCount < maxRetries) {
            console.log(`Retrying saveToSupabase(${ retryCount + 1}/${maxRetries})...`);
            setTimeout(() => saveToSupabase(retryCount + 1, maxRetries), 1000);
          } else {
            Swal.fire({
              icon: "error",
              title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
              text: error.message,
            });
          }
        }
      }

      async function saveTemplateToSupabase(retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          Swal.fire({
            icon: "error",
            title: "โปรไฟล์ยังไม่โหลด",
            text: "กรุณารอสักครู่แล้วลองใหม่",
          });
          return;
        }
        const templateJson = document.getElementById("textBox2").value.trim();
        const title = document.getElementById("textBox1").value.trim();
        if (!title) {
          Swal.fire({
            icon: "error",
            title: "กรุณากรอกหัวข้อ",
            text: "หัวข้อไม่สามารถเป็นค่าว่างได้",
          });
          return;
        }
        if (!templateJson) {
          Swal.fire({
            icon: "error",
            title: "กรุณากรอก JSON",
            text: "JSON ไม่สามารถเป็นค่าว่างได้",
          });
          return;
        }
        let templateObj;
        try {
          templateObj = JSON.parse(templateJson);
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "JSON ไม่ถูกต้อง",
            text: `กรุณาตรวจสอบ JSON ของคุณ: ${ error.message } `,
          });
          return;
        }
        const data = {
          title: title,
          text1: templateJson,
          userId: profile.userId,
          displayName: profile.displayName,
          type: "template"
        };
        Swal.fire({
          title: "กำลังบันทึกข้อมูล...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        try {
          const response = await fetch(SUPABASE_FUNCTIONS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${ response.status } `;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${ text } `;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${ text } `;
            }
            throw new Error(errorMessage);
          }
          const result = await response.json();
          if (result.success) {
            Swal.fire({
              icon: "success",
              title: "บันทึกข้อมูลเรียบร้อย!",
              timer: 1500,
              showConfirmButton: false,
            });
            clearInputs();
            fetchDataList();
          } else {
            throw new Error(result.error || "Unknown error occurred");
          }
        } catch (error) {
          console.error("Error saving data:", error);
          if (retryCount < maxRetries) {
            console.log(`Retrying saveTemplateToSupabase(${ retryCount + 1}/${maxRetries})...`);
            setTimeout(() => saveTemplateToSupabase(retryCount + 1, maxRetries), 1000);
          } else {
            Swal.fire({
              icon: "error",
              title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
              text: error.message,
            });
          }
        }
      }

      async function saveImagemapToSupabase(retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          Swal.fire({
            icon: "error",
            title: "โปรไฟล์ยังไม่โหลด",
            text: "กรุณารอสักครู่แล้วลองใหม่",
          });
          return;
        }
        const imagemapJson = document.getElementById("textBox2").value.trim();
        const title = document.getElementById("textBox1").value.trim();
        if (!title) {
          Swal.fire({
            icon: "error",
            title: "กรุณากรอกหัวข้อ",
            text: "หัวข้อไม่สามารถเป็นค่าว่างได้",
          });
          return;
        }
        if (!imagemapJson) {
          Swal.fire({
            icon: "error",
            title: "กรุณากรอก JSON",
            text: "JSON ไม่สามารถเป็นค่าว่างได้",
          });
          return;
        }
        let imagemapObj;
        try {
          imagemapObj = JSON.parse(imagemapJson);
          if (imagemapObj.type !== "imagemap") {
            throw new Error("JSON must have type: 'imagemap'");
          }
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "JSON ไม่ถูกต้อง",
            text: `กรุณาตรวจสอบ JSON Imagemap ของคุณ: ${ error.message } `,
          });
          return;
        }
        const data = {
          title: title,
          text1: JSON.stringify({ ...imagemapObj, messageType: "imagemap" }),
          userId: profile.userId,
          displayName: profile.displayName,
          type: "flex"
        };
        Swal.fire({
          title: "กำลังบันทึกข้อมูล...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        try {
          const response = await fetch(SUPABASE_FUNCTIONS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${ response.status } `;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${ text } `;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${ text } `;
            }
            throw new Error(errorMessage);
          }
          const result = await response.json();
          if (result.success) {
            Swal.fire({
              icon: "success",
              title: "บันทึกข้อมูลเรียบร้อย!",
              timer: 1500,
              showConfirmButton: false,
            });
            clearInputs();
            fetchDataList();
          } else {
            throw new Error(result.error || "Unknown error occurred");
          }
        } catch (error) {
          console.error("Error saving data:", error);
          if (retryCount < maxRetries) {
            console.log(`Retrying saveImagemapToSupabase(${ retryCount + 1}/${maxRetries})...`);
            setTimeout(() => saveImagemapToSupabase(retryCount + 1, maxRetries), 1000);
          } else {
            Swal.fire({
              icon: "error",
              title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
              text: error.message,
            });
          }
        }
      }

      async function fetchDataList(retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          console.warn("Profile not loaded yet, skipping fetchDataList");
          return;
        }
        try {
          // Remove the space in the query parameter
          const response = await fetch(`${SUPABASE_FUNCTIONS_URL}?userId=${encodeURIComponent(profile.userId)}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${response.status}`;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${text}`;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${text}`;
            }
            throw new Error(errorMessage);
          }
          const data = await response.json();
          if (!Array.isArray(data)) {
            throw new Error("Data is not an array");
          }
          window.listData = data;
          const listHtml = data
            .map((item) => {
              const title = escapeHtml(item.title || "");
              let displayType = item.type;
              try {
                const obj = JSON.parse(item.text1);
                if (obj.messageType === "imagemap") {
                  displayType = "imagemap";
                }
              } catch (e) {
                console.warn("Error parsing item text1:", e);
              }
              return `
                <div class="card" id="item-${item.id}">
                  <div class="card-body">
                    <h5 class="card-title">${title} (${displayType})</h5>
                    <div class="btn-group">
                      <button class="btn btn-sm btn-primary" onclick="shareListItem('${item.id}')">แชร์</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteListItem('${item.id}')">ลบ</button>
                      <button class="btn btn-sm btn-info" onclick="showMessage('${item.id}')">แสดง</button>
                    </div>
                  </div>
                </div>
              `;
            })
            .join("");
          const dataListElement = document.getElementById("dataList");
          if (dataListElement) {
            dataListElement.innerHTML = listHtml || "<p>ไม่มีข้อมูล</p>";
          } else {
            console.error("Element with id 'dataList' not found");
          }
        } catch (error) {
          console.error("Error fetching data:", error);
          if (retryCount < maxRetries) {
            console.log(`Retrying fetchDataList(${retryCount + 1}/${maxRetries})...`);
            setTimeout(() => fetchDataList(retryCount + 1, maxRetries), 1000);
          } else {
            const dataListElement = document.getElementById("dataList");
            if (dataListElement) {
              dataListElement.innerHTML = `<p class="text-danger">Error loading data: ${error.message}</p>`;
            }
            Swal.fire({
              icon: "error",
              title: "ไม่สามารถโหลดข้อมูลได้",
              text: "กรุณาลองรีเฟรชหน้าเว็บ",
            });
          }
        }
      }

      async function showMessage(id, retryCount = 0, maxRetries = 1) {
        if (!window.listData || !Array.isArray(window.listData)) {
          console.warn("listData is not initialized, attempting to fetch...");
          if (retryCount < maxRetries) {
            await fetchDataList();
            showMessage(id, retryCount + 1, maxRetries);
          } else {
            Swal.fire({
              icon: "error",
              title: "ไม่สามารถโหลดข้อมูลได้",
              text: "ไม่สามารถโหลดรายการข้อมูล กรุณารีเฟรชหน้าเว็บ",
              confirmButtonText: "รีเฟรช",
            }).then((result) => {
              if (result.isConfirmed) {
                fetchDataList();
              }
            });
          }
          return;
        }
        const item = window.listData.find(item => String(item.id) === String(id));
        if (!item) {
          console.error("showMessage: Item not found for id:", id);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแสดงข้อมูลได้",
            text: "ไม่พบรายการที่ร้องขอ กรุณารีเฟรชหน้าเว็บ",
            confirmButtonText: "รีเฟรช",
          }).then((result) => {
            if (result.isConfirmed) {
              fetchDataList();
            }
          });
          return;
        }
        if (!item.text1 || !item.type) {
          console.error("showMessage: Missing text1 or type for item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแสดงข้อมูลได้",
            text: "ข้อมูลข้อความไม่สมบูรณ์",
          });
          return;
        }
        const flexContainer = document.getElementById("flex1");
        if (!flexContainer) {
          console.error("Flex container not found");
          Swal.fire({
            icon: "error",
            title: "ข้อผิดพลาด",
            text: "ไม่พบคอนเทนเนอร์สำหรับแสดงข้อความ",
          });
          return;
        }
        flexContainer.innerHTML = "";
        try {
          document.getElementById("textBox2").value = item.text1;
          formatJson();
          const obj = JSON.parse(item.text1);
          if (obj.messageType === "imagemap") {
            renderImagemap(obj, flexContainer);
            flexContainer.style.display = "block";
            flexContainer.scrollIntoView({ behavior: "smooth" });
          } else if (item.type === "flex") {
            if (!isValidFlexMessage(obj)) {
              throw new Error("Invalid Flex message structure");
            }
            let flexMessage;
            if (obj.type === "carousel" || obj.type === "bubble") {
              flexMessage = {
                type: "flex",
                altText: item.title || "Flex Message",
                contents: obj,
              };
            } else {
              flexMessage = obj;
            }
            if (typeof flex2html === "function") {
              flex2html("flex1", flexMessage);
              flexContainer.style.display = "block";
              flexContainer.classList.remove("bg-white", "p-2", "rounded");
              flexContainer.scrollIntoView({ behavior: "smooth" });
            } else {
              console.error("flex2html function is not available");
              flexContainer.innerHTML = '<p class="text-danger">flex2html library is not loaded properly.</p>';
            }
          } else if (item.type === "template") {
            flexContainer.innerHTML = `< pre > ${ JSON.stringify(obj, null, 2) }</pre > `;
            flexContainer.style.display = "block";
            flexContainer.scrollIntoView({ behavior: "smooth" });
          } else {
            throw new Error("Unknown message type");
          }
        } catch (e) {
          console.error("Error parsing or displaying message JSON:", e, "item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแสดงข้อความได้",
            text: `รูปแบบข้อมูลไม่ถูกต้อง: ${ e.message } `,
          });
        }
      }

      async function deleteItemFromServer(id, retryCount = 0, maxRetries = 3) {
        if (!profile || !profile.userId) {
          throw new Error("โปรไฟล์ยังไม่โหลด");
        }
        try {
          const response = await fetch(`${SUPABASE_FUNCTIONS_URL}?id=${encodeURIComponent(id)}&userId=${encodeURIComponent(profile.userId)}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });
          if (!response.ok) {
            const text = await response.text();
            let errorMessage = `Network response was not ok: ${response.status}`;
            if (response.status === 400) {
              errorMessage = `Invalid request: ${text}`;
            } else if (response.status === 403) {
              errorMessage = `Unauthorized: ${text}`;
            } else if (response.status === 404) {
              errorMessage = `Item not found: ${text}`;
            } else if (response.status === 500) {
              errorMessage = `Server error: ${text}`;
            }
            throw new Error(errorMessage);
          }
          const data = await response.json();
          if (!data.success) {
            throw new Error(data.error || "Unknown error occurred");
          }
          return data;
        } catch (error) {
          if (retryCount < maxRetries) {
            console.log(`Retrying deleteItemFromServer(${retryCount + 1}/${maxRetries})...`);
            await new Promise(resolve => setTimeout(resolve, 1000));
            return deleteItemFromServer(id, retryCount + 1, maxRetries);
          }
          throw error;
        }
      }

                                                                               
      function deleteListItem(id) {
        Swal.fire({
          title: "คุณแน่ใจหรือไม่?",
          text: "คุณไม่สามารถย้อนกลับการกระทำนี้ได้!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "ใช่, ลบเลย!",
          cancelButtonText: "ยกเลิก",
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire({
              title: "กำลังลบ...",
              text: "โปรดรอสักครู่",
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });
            deleteItemFromServer(id)
              .then(() => {
                Swal.fire("ลบแล้ว!", "รายการได้ถูกลบเรียบร้อยแล้ว", "success");
                fetchDataList();
              })
              .catch((error) => {
                console.error("Error deleting item:", error);
                Swal.fire(
                  "เกิดข้อผิดพลาด!",
                  `ไม่สามารถลบรายการได้: ${ error.message } `,
                  "error"
                );
              });
          }
        });
      }

      function escapeHtml(unsafe) {
        if (typeof unsafe !== "string") {
          return "";
        }
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      async function shareListItem(id, retryCount = 0, maxRetries = 1) {
        if (!window.listData || !Array.isArray(window.listData)) {
          console.warn("listData is not initialized, attempting to fetch...");
          if (retryCount < maxRetries) {
            await fetchDataList();
            shareListItem(id, retryCount + 1, maxRetries);
          } else {
            Swal.fire({
              icon: "error",
              title: "ไม่สามารถโหลดข้อมูลได้",
              text: "ไม่สามารถโหลดรายการข้อมูล กรุณารีเฟรชหน้าเว็บ",
              confirmButtonText: "รีเฟรช",
            }).then((result) => {
              if (result.isConfirmed) {
                fetchDataList();
              }
            });
          }
          return;
        }
        const item = window.listData.find(item => String(item.id) === String(id));
        if (!item) {
          console.error("shareListItem: Item not found for id:", id);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแชร์ข้อมูลได้",
            text: "ไม่พบรายการที่ร้องขอ กรุณารีเฟรชหน้าเว็บ",
            confirmButtonText: "รีเฟรช",
          }).then((result) => {
            if (result.isConfirmed) {
              fetchDataList();
            }
          });
          return;
        }
        if (!item.text1 || !item.type) {
          console.error("shareListItem: Missing text1 or type for item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถแชร์ข้อมูลได้",
            text: "ข้อมูลข้อความไม่สมบูรณ์",
          });
          return;
        }
        try {
          document.getElementById("textBox2").value = item.text1;
          const messageObjRaw = JSON.parse(item.text1);
          let messageObj;
          if (messageObjRaw.messageType === "imagemap") {
            messageObj = {
              type: "imagemap",
              baseUrl: messageObjRaw.baseUrl,
              altText: messageObjRaw.altText,
              baseSize: messageObjRaw.baseSize,
              actions: messageObjRaw.actions
            };
          } else if (item.type === "flex") {
            if (!isValidFlexMessage(messageObjRaw)) {
              throw new Error("Invalid Flex message structure");
            }
            messageObj = {
              type: "flex",
              altText: item.title || "Flex Message",
              contents: messageObjRaw.type === "bubble" || messageObjRaw.type === "carousel" ? messageObjRaw : messageObjRaw.contents
            };
          } else if (item.type === "template") {
            messageObj = messageObjRaw;
          } else {
            throw new Error("Unknown message type");
          }
          sendMessage(messageObj);
        } catch (e) {
          console.error("Error parsing or sending message JSON:", e, "item:", item);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถส่งข้อความได้",
            text: `รูปแบบข้อมูลไม่ถูกต้อง: ${ e.message }`,
          });
        }
      }

      function sendMessage(messageObj) {
        if (!liff.isInClient()) {
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถส่งข้อความได้",
            text: "กรุณาเปิดแอปพลิเคชันนี้ใน LINE เพื่อส่งข้อความ",
          });
          return;
        }
        try {
          liff
            .shareTargetPicker([messageObj])
            .then(() => {
              Swal.fire({
                icon: "success",
                title: "ส่งข้อความเรียบร้อย!",
                timer: 1500,
                showConfirmButton: false,
              });
              document.getElementById("textBox1").value = "";
              document.getElementById("textBox2").value = "";
            })
            .catch((error) => {
              console.error("Error sending message:", error);
              Swal.fire({
                icon: "error",
                title: "เกิดข้อผิดพลาดในการส่งข้อความ",
                text: error.message || "ไม่สามารถส่งข้อความได้ กรุณาตรวจสอบการกำหนดค่า LIFF",
              });
            });
        } catch (error) {
          console.error("Error initiating shareTargetPicker:", error);
          Swal.fire({
            icon: "error",
            title: "เกิดข้อผิดพลาด",
            text: "ไม่สามารถเริ่มต้นการส่งข้อความได้ กรุณาตรวจสอบ LIFF ID และการกำหนดค่าใน LINE Developers Console",
          });
        }
      }

      function clearInputs() {
        const textBox1 = document.getElementById("textBox1");
        const textBox2 = document.getElementById("textBox2");
        if (textBox1) textBox1.value = "";
        if (textBox2) textBox2.value = "";
      }
  </script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>
